{% extends "base.html" %}

{% block title %}Import Employees{% endblock %}

{% block extra_css %}
<style>
    .import-card {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
    }
    
    .step {
        flex: 1;
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 0 0.5rem;
        position: relative;
    }
    
    .step.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .step::after {
        content: '';
        position: absolute;
        top: 50%;
        right: -0.5rem;
        width: 0;
        height: 0;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        border-left: 10px solid #f8f9fa;
        transform: translateY(-50%);
    }
    
    .step.active::after {
        border-left-color: #764ba2;
    }
    
    .step:last-child::after {
        display: none;
    }
    
    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 3rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .file-upload-area:hover {
        border-color: #6f42c1;
        background-color: #f8f9fa;
    }
    
    .file-upload-area.dragover {
        border-color: #6f42c1;
        background-color: #e7e3ff;
    }
    
    .file-upload-area.file-selected {
        border-color: #28a745;
        background-color: #d4edda;
    }
    
    .sample-table {
        font-size: 0.75rem;
    }
    
    .requirements-list {
        background: #f8f9fa;
        border-left: 4px solid #6f42c1;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .field-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
    }
    
    .field-category {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .field-category h6 {
        color: #6f42c1;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="bi bi-upload"></i> Import Employees
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{{ url_for('admin.employee_database') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Database
                </a>
                <a href="{{ url_for('admin.download_employee_template') }}" class="btn btn-success">
                    <i class="bi bi-download"></i> Download Template
                </a>
            </div>
        </div>
    </div>

    <div class="card import-card">
        <div class="card-body">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active">
                    <div class="h6 mb-1">1</div>
                    <small>Download Template</small>
                </div>
                <div class="step">
                    <div class="h6 mb-1">2</div>
                    <small>Prepare Data</small>
                </div>
                <div class="step">
                    <div class="h6 mb-1">3</div>
                    <small>Upload CSV</small>
                </div>
                <div class="step">
                    <div class="h6 mb-1">4</div>
                    <small>Review Results</small>
                </div>
            </div>

            <!-- Instructions -->
            <div class="mb-4">
                <h5>
                    <i class="bi bi-info-circle"></i> Import Instructions
                </h5>
                
                <div class="requirements-list">
                    <h6>Requirements:</h6>
                    <ul class="mb-0">
                        <li><strong>File Format:</strong> CSV (Comma Separated Values) only</li>
                        <li><strong>Required Fields:</strong> Username, Email Address, First Name, Last Name</li>
                        <li><strong>Date Format:</strong> YYYY-MM-DD or MM/DD/YYYY for hiring dates</li>
                        <li><strong>Hierarchy:</strong> Department/Division/Section/Unit must exist in the system before import</li>
                        <li><strong>New Users:</strong> Will be created with default password "password123"</li>
                        <li><strong>Existing Users:</strong> Will be updated with new information</li>
                        <li><strong>Employee Types:</strong> rank_and_file, rank_and_file_probationary, confidential, confidential_probationary, contractual</li>
                        <li><strong>Schedule Formats:</strong> 8_hour_shift, 9_hour_shift, others (or display names: "8-hour shift", "9-hour shift", "Others")</li>
                        <li><strong>Roles:</strong> employee, manager, administrator</li>
                    </ul>
                </div>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Important:</strong> This operation will create new users or update existing ones. 
                    Please review your data carefully before importing. New users will need to change their 
                    default password on first login.
                </div>
            </div>

            <!-- Field Categories -->
            <div class="mb-4">
                <h6>Available Fields by Category:</h6>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="field-category">
                            <h6><i class="bi bi-person"></i> Required Fields</h6>
                            <div class="field-grid">
                                <span class="badge bg-danger">Username*</span>
                                <span class="badge bg-danger">Email Address*</span>
                                <span class="badge bg-danger">First Name*</span>
                                <span class="badge bg-danger">Last Name*</span>
                            </div>
                        </div>
                        
                        <div class="field-category">
                            <h6><i class="bi bi-building"></i> Organizational Hierarchy</h6>
                            <div class="field-grid">
                                <span class="badge bg-dark">Department</span>
                                <span class="badge bg-warning text-dark">Division</span>
                                <span class="badge bg-primary">Section</span>
                                <span class="badge bg-info">Unit</span>
                            </div>
                        </div>
                        
                        <div class="field-category">
                            <h6><i class="bi bi-briefcase"></i> Employment Information</h6>
                            <div class="field-grid">
                                <span class="badge bg-secondary">Employee Type</span>
                                <span class="badge bg-light text-dark">Schedule Format</span>
                                <span class="badge bg-success">Date Hired</span>
                                <span class="badge bg-secondary">Job Title</span>
                                <span class="badge bg-secondary">Rank</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="field-category">
                            <h6><i class="bi bi-card-text"></i> Identification</h6>
                            <div class="field-grid">
                                <span class="badge bg-primary">Personnel Number</span>
                                <span class="badge bg-info">ID Number</span>
                                <span class="badge bg-secondary">Type Code</span>
                                <span class="badge bg-light text-dark">Div/Dept</span>
                            </div>
                        </div>
                        
                        <div class="field-category">
                            <h6><i class="bi bi-telephone"></i> Contact Information</h6>
                            <div class="field-grid">
                                <span class="badge bg-success">Contact Number</span>
                            </div>
                        </div>
                        
                        <div class="field-category">
                            <h6><i class="bi bi-shield-check"></i> System & Permissions</h6>
                            <div class="field-grid">
                                <span class="badge bg-warning text-dark">Role</span>
                                <span class="badge bg-primary">Is Department Approver</span>
                                <span class="badge bg-primary">Is Division Approver</span>
                                <span class="badge bg-primary">Is Section Approver</span>
                                <span class="badge bg-primary">Is Unit Approver</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sample Data Preview -->
            <div class="mb-4">
                <h6>Sample CSV Format (showing key fields):</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered sample-table">
                        <thead class="table-light">
                            <tr>
                                <th>Username*</th>
                                <th>Email Address*</th>
                                <th>First Name*</th>
                                <th>Last Name*</th>
                                <th>Date Hired</th>
                                <th>Department</th>
                                <th>Division</th>
                                <th>Section</th>
                                <th>Unit</th>
                                <th>Job Title</th>
                                <th>Employee Type</th>
                                <th>Schedule Format</th>
                                <th>Role</th>
                                <th>Contact Number</th>
                                <th>Personnel Number</th>
                                <th>ID Number</th>
                                <th>Is Section Approver</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>hgspecter</td>
                                <td>hgspecter@email.com</td>
                                <td>Harvey</td>
                                <td>Specter</td>
                                <td>2023-01-15</td>
                                <td>Post Production</td>
                                <td>TMSSD</td>
                                <td>IT Solutions</td>
                                <td>IT Infrastructure</td>
                                <td>IT Specialist</td>
                                <td>confidential</td>
                                <td>8-hour shift</td>
                                <td>employee</td>
                                <td>+639101234567</td>
                                <td>1289000</td>
                                <td>001D</td>
                                <td>TRUE</td>
                            </tr>
                            <tr>
                                <td>ymhanna</td>
                                <td>ymhanna@email.com</td>
                                <td>Yuna</td>
                                <td>Hanna</td>
                                <td>2022-06-01</td>
                                <td>Post Production</td>
                                <td>Operations Division</td>
                                <td>Video Editing</td>
                                <td></td>
                                <td>Video Editor 3</td>
                                <td>rank_and_file</td>
                                <td>9-hour shift</td>
                                <td>employee</td>
                                <td>+639187654321</td>
                                <td>1290001</td>
                                <td>002E</td>
                                <td>FALSE</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <small class="text-muted">* Required fields. For boolean fields (approver status), use TRUE/FALSE or 1/0.</small>
            </div>

            <!-- Upload Form -->
            <form method="POST" action="{{ url_for('admin.import_employee_database') }}" enctype="multipart/form-data" id="import-form">
                <div class="mb-4">
                    <h6>Upload CSV File:</h6>
                    <div class="file-upload-area" id="file-upload-area">
                        <div id="upload-content">
                            <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                            <h5>Drag and drop your CSV file here</h5>
                            <p class="text-muted">or click to browse and select a file</p>
                            <button type="button" class="btn btn-primary" id="choose-file-btn">
                                Choose File
                            </button>
                        </div>
                        <div id="file-selected-content" style="display: none;">
                            <i class="bi bi-check-circle display-4 text-success mb-3"></i>
                            <h5 class="text-success" id="selected-file-name">File Selected</h5>
                            <p class="text-muted" id="selected-file-size">0 KB</p>
                            <button type="button" class="btn btn-outline-primary" id="change-file-btn">
                                Choose Different File
                            </button>
                        </div>
                    </div>
                    
                    <input type="file" 
                           name="csv_file" 
                           id="csv_file" 
                           accept=".csv,text/csv" 
                           style="display: none;" 
                           required>
                </div>

                <div class="mb-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirm-import" name="confirm_import" required>
                        <label class="form-check-label" for="confirm-import">
                            I understand that this will create/update employee records and have reviewed the data carefully.
                        </label>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{{ url_for('admin.employee_database') }}" class="btn btn-secondary me-md-2">
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-primary" id="import-btn" disabled>
                        <i class="bi bi-upload"></i> Import Employees
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Available Organizations Display -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-building"></i> Available Departments
                    </h6>
                </div>
                <div class="card-body">
                    {% if departments %}
                        {% for department in departments %}
                        <div class="mb-2">
                            <span class="badge bg-dark">{{ department.name }}</span>
                            {% if department.description %}
                            <br><small class="text-muted">{{ department.description }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">No departments available. Create departments first.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-diagram-2"></i> Available Divisions
                    </h6>
                </div>
                <div class="card-body">
                    {% if divisions %}
                        {% for division in divisions %}
                        <div class="mb-2">
                            <span class="badge bg-warning text-dark">{{ division.name }}</span>
                            <br><small class="text-muted">{{ division.department.name }}</small>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">No divisions available. Create divisions first.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-building"></i> Available Sections
                    </h6>
                </div>
                <div class="card-body">
                    {% if sections %}
                        {% for section in sections %}
                        <div class="mb-2">
                            <span class="badge bg-primary">{{ section.name }}</span>
                            {% if section.division %}
                            <br><small class="text-muted">{{ section.division.name }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">No sections available. Create sections first.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-diagram-3"></i> Available Units
                    </h6>
                </div>
                <div class="card-body">
                    {% if units %}
                        {% for unit in units %}
                        <div class="mb-2">
                            <span class="badge bg-info">{{ unit.name }}</span>
                            <br><small class="text-muted">{{ unit.section.name }}</small>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">No units available. Create units first.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('csv_file');
    const fileUploadArea = document.getElementById('file-upload-area');
    const importBtn = document.getElementById('import-btn');
    const confirmCheckbox = document.getElementById('confirm-import');
    const chooseFileBtn = document.getElementById('choose-file-btn');
    const changeFileBtn = document.getElementById('change-file-btn');
    const uploadContent = document.getElementById('upload-content');
    const fileSelectedContent = document.getElementById('file-selected-content');
    const selectedFileName = document.getElementById('selected-file-name');
    const selectedFileSize = document.getElementById('selected-file-size');

    // File upload area click handler
    fileUploadArea.addEventListener('click', function(e) {
        if (e.target === fileUploadArea || e.target.closest('#upload-content')) {
            fileInput.click();
        }
    });

    // Choose file button click handler
    chooseFileBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.click();
    });

    // Change file button click handler
    changeFileBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.click();
    });

    // Drag and drop handlers
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileUploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (validateFile(file)) {
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    });

    // File input change handler
    fileInput.addEventListener('change', function(e) {
        console.log('File input changed:', this.files);
        if (this.files.length > 0) {
            const file = this.files[0];
            if (validateFile(file)) {
                handleFileSelection(file);
            } else {
                this.value = '';
            }
        } else {
            showUploadArea();
        }
        checkFormValidity();
    });

    // Confirmation checkbox handler
    confirmCheckbox.addEventListener('change', function() {
        checkFormValidity();
    });

    function validateFile(file) {
        // Check file type
        const validTypes = ['text/csv', 'application/vnd.ms-excel'];
        const isValidType = validTypes.includes(file.type) || file.name.toLowerCase().endsWith('.csv');
        
        if (!isValidType) {
            alert('Please select a CSV file only.');
            return false;
        }

        // Check file size (limit to 10MB)
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            alert('File size too large. Please select a file smaller than 10MB.');
            return false;
        }

        return true;
    }

    function handleFileSelection(file) {
        console.log('Handling file selection:', file.name);
        selectedFileName.textContent = file.name;
        selectedFileSize.textContent = formatFileSize(file.size);
        
        // Show file selected state
        uploadContent.style.display = 'none';
        fileSelectedContent.style.display = 'block';
        fileUploadArea.classList.add('file-selected');
    }

    function showUploadArea() {
        uploadContent.style.display = 'block';
        fileSelectedContent.style.display = 'none';
        fileUploadArea.classList.remove('file-selected');
    }

    function checkFormValidity() {
        const hasFile = fileInput.files.length > 0;
        const isConfirmed = confirmCheckbox.checked;
        
        console.log('Checking form validity - hasFile:', hasFile, 'isConfirmed:', isConfirmed);
        importBtn.disabled = !(hasFile && isConfirmed);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Form submission handler
    document.getElementById('import-form').addEventListener('submit', function(e) {
        console.log('Form submission triggered');
        console.log('File input files:', fileInput.files);
        console.log('File input value:', fileInput.value);
        
        // Validation
        if (!fileInput.files || fileInput.files.length === 0) {
            e.preventDefault();
            alert('Please select a CSV file.');
            return false;
        }

        if (!confirmCheckbox.checked) {
            e.preventDefault();
            alert('Please confirm that you have reviewed the data carefully.');
            return false;
        }

        // Show loading state
        importBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Importing...';
        importBtn.disabled = true;
        
        console.log('Form validation passed, submitting...');
        return true;
    });

    // Initial form state check
    checkFormValidity();
});
</script>
{% endblock %}
