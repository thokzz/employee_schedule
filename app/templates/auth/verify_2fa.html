<!-- app/templates/auth/verify_2fa.html -->
{% extends "base.html" %}

{% block title %}Two-Factor Authentication{% endblock %}

{% block content %}
<div class="container-fluid vh-100">
    <div class="row h-100">
        <div class="col-md-6 d-flex align-items-center justify-content-center">
            <div class="card shadow-lg border-0" style="max-width: 450px; width: 100%;">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="bi bi-shield-lock display-4 text-primary mb-3"></i>
                        <h3 class="fw-bold text-primary">Two-Factor Authentication</h3>
                        <p class="text-muted">Enter your verification code to continue</p>
                    </div>

                    <div class="alert alert-info text-center">
                        {% if user_2fa.primary_method.value == 'totp' %}
                        <i class="bi bi-phone"></i>
                        Open your <strong>authenticator app</strong> and enter the 6-digit code
                        {% elif user_2fa.primary_method.value == 'sms' %}
                        <i class="bi bi-chat-dots"></i>
                        Check your <strong>text messages</strong> for the verification code
                        {% elif user_2fa.primary_method.value == 'email' %}
                        <i class="bi bi-envelope"></i>
                        Check your <strong>email</strong> for the verification code
                        {% endif %}
                    </div>

                    <form method="POST" id="verify-form">
                        <div class="mb-3">
                            <label for="verification_code" class="form-label">Verification Code</label>
                            <input type="text" class="form-control form-control-lg text-center" 
                                   id="verification_code" name="verification_code" 
                                   placeholder="000000" maxlength="6" required
                                   style="letter-spacing: 0.5em; font-size: 1.5rem;">
                        </div>

                        {% if settings.remember_device_enabled %}
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="remember_device" name="remember_device">
                                <label class="form-check-label" for="remember_device">
                                    Remember this device for {{ settings.remember_device_days }} days
                                </label>
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> Verify
                            </button>
                        </div>
                    </form>

                    <hr class="my-4">

                    <!-- Backup code option -->
                    <div class="text-center">
                        <button type="button" class="btn btn-link" onclick="toggleBackupCode()">
                            <i class="bi bi-key"></i> Use backup code instead
                        </button>
                    </div>

                    <div id="backup-code-form" style="display: none;">
                        <form method="POST">
                            <div class="mb-3">
                                <label for="backup_code" class="form-label">Backup Code</label>
                                <input type="text" class="form-control" id="backup_code" 
                                       name="verification_code" placeholder="XXXX-XXXX">
                                <input type="hidden" name="use_backup" value="true">
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-unlock"></i> Use Backup Code
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Resend code option for SMS/Email -->
                    {% if user_2fa.primary_method.value in ['sms', 'email'] %}
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="resendCode()">
                            <i class="bi bi-arrow-repeat"></i> Resend Code
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6 d-none d-md-flex align-items-center justify-content-center" 
             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="text-center text-white p-4">
                <i class="bi bi-shield-check display-1 mb-4"></i>
                <h2 class="fw-bold mb-4">Almost There!</h2>
                <p class="lead">
                    You're just one step away from accessing your account securely.
                </p>
                
                <div class="mt-5">
                    <div class="row">
                        <div class="col-6 text-center">
                            <i class="bi bi-check-circle display-4 mb-3"></i>
                            <h6>Password âœ“</h6>
                            <small>First factor verified</small>
                        </div>
                        <div class="col-6 text-center">
                            <i class="bi bi-clock display-4 mb-3"></i>
                            <h6>2FA Code</h6>
                            <small>Waiting for verification</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-format and submit verification code
document.getElementById('verification_code').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.length > 6) {
        value = value.substring(0, 6);
    }
    
    e.target.value = value;
    
    if (value.length === 6) {
        setTimeout(() => {
            document.getElementById('verify-form').submit();
        }, 500);
    }
});

// Format backup code input
document.getElementById('backup_code').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^A-Z0-9]/g, '');
    
    // Add dash after 4 characters
    if (value.length > 4) {
        value = value.substring(0, 4) + '-' + value.substring(4, 8);
    }
    
    e.target.value = value;
});

function toggleBackupCode() {
    const backupForm = document.getElementById('backup-code-form');
    const verifyForm = document.getElementById('verify-form');
    
    if (backupForm.style.display === 'none') {
        backupForm.style.display = 'block';
        verifyForm.style.display = 'none';
        document.getElementById('backup_code').focus();
    } else {
        backupForm.style.display = 'none';
        verifyForm.style.display = 'block';
        document.getElementById('verification_code').focus();
    }
}

function resendCode() {
    const method = '{{ user_2fa.primary_method.value }}';
    
    fetch('{{ url_for("auth.send_2fa_code") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            method: method
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Code sent successfully!', 'success');
        } else {
            showToast('Failed to send code. Please try again.', 'danger');
        }
    })
    .catch(error => {
        showToast('Error sending code. Please try again.', 'danger');
    });
}

function showToast(message, type) {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Focus input on page load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('verification_code').focus();
});
</script>
{% endblock %}