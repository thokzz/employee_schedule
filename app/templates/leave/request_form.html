<!-- Update app/templates/leave/request_form.html - Add work extension integration -->

{% extends "base.html" %}

{% block title %}Request Leave{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Request Leave</h1>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

<form action="{{ url_for('leave.submit_leave') }}" method="POST" class="leave-form">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4><i class="bi bi-person-circle"></i> Employee Information</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label class="form-label">Employee Name</label>
                        <input type="text" class="form-control" value="{{ current_user.full_name }}" readonly>
                        <input type="hidden" id="employee_id" name="employee_id" value="{{ current_user.id }}">
                        <input type="hidden" id="employee_name" name="employee_name" value="{{ current_user.full_name }}">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label class="form-label">ID Number</label>
                        <input type="text" id="employee_idno" name="id_no" class="form-control" 
                               value="{{ current_user.id_number or 'Not Set' }}" readonly>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label class="form-label">Div./Department</label>
                        <input type="text" id="employee_unit" name="dept" class="form-control" 
                               value="{{ current_user.div_department or 'Not Assigned' }}" readonly>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label class="form-label">Date Filed</label>
                        <input type="text" id="date_filed" name="date_filed" class="form-control" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label class="form-label">Reference Code</label>
                        <input type="text" id="unique_code" name="unique_code" class="form-control" readonly>
                        <small class="text-muted">Auto-generated</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="contact" class="form-label">Contact Number <span class="text-danger">*</span></label>
                        <input type="tel" id="contact" name="contact" class="form-control" required 
                               value="{{ current_user.contact_number or '' }}"
                               placeholder="Where you can be contacted during leave">
                    </div>
                </div>
            </div>
            
            <!-- Hidden fields for employee info -->
            <input type="hidden" id="employee_email" name="employee_email" value="{{ current_user.email }}">
            <input type="hidden" id="employee_signature_path" name="employee_signature_path" value="{{ current_user.signature_path or '' }}">
            <input type="hidden" id="signature" name="signature" value="{{ current_user.signature_path or '' }}">
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h4><i class="bi bi-calendar-event"></i> Leave Details</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="leave_type" class="form-label">Type of Leave <span class="text-danger">*</span></label>
                        <select id="leave_type" name="leave_type" required class="form-select">
                            <option value="" disabled selected>Select leave type</option>
                            {% for leave_type in leave_types %}
                                {% if leave_type.value == 'Other' %}
                                    {% if current_user.can_file_work_extension() %}
                                        <option value="{{ leave_type.value }}" data-requires-extensions="true">{{ leave_type.value }} (Offset for Work Extension)</option>
                                    {% endif %}
                                {% else %}
                                    <option value="{{ leave_type.value }}">{{ leave_type.value }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if current_user.can_file_work_extension() %}
                            <small class="text-muted">"Other" is for offsetting approved work extensions</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Work Extension Selection Section (only for "Other" leave type) -->
            {% if current_user.can_file_work_extension() and approved_work_extensions %}
            <div id="work_extensions_section" style="display: none;">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>"Other" Leave Type:</strong> Select the approved work extensions you want to offset with this leave request.
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <h5>Select Approved Work Extensions to Attach:</h5>
                        <div class="border rounded p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                            {% for extension in approved_work_extensions %}
                            <div class="form-check mb-2">
                                <input class="form-check-input work-extension-checkbox" type="checkbox" 
                                       name="work_extensions" value="{{ extension.id }}" 
                                       id="extension_{{ extension.id }}"
                                       data-hours="{{ extension.extension_hours or 0 }}"
                                       data-date="{{ extension.extension_date.strftime('%m/%d/%Y') }}">
                                <label class="form-check-label" for="extension_{{ extension.id }}">
                                    <strong>{{ extension.reference_code }}</strong> - 
                                    {{ extension.extension_date.strftime('%b %d, %Y') }}
                                    {% if extension.extension_hours %}
                                        ({{ extension.extension_hours }} hours)
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ extension.reason[:100] }}{% if extension.reason|length > 100 %}...{% endif %}</small>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Selected Extensions Summary</label>
                                    <div id="selected_extensions_summary" class="form-control" readonly style="min-height: 60px; background-color: #f8f9fa;">
                                        <small class="text-muted">No extensions selected</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Total Extension Hours</label>
                                    <input type="text" id="total_extension_hours" class="form-control" readonly value="0 hours">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% elif current_user.can_file_work_extension() and not approved_work_extensions %}
            <div id="no_extensions_warning" style="display: none;">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>No Approved Work Extensions:</strong> You don't have any approved work extensions to offset. 
                    Please submit and get approval for work extensions first before filing an "Other" leave type.
                </div>
            </div>
            {% endif %}
            
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group mb-3">
                        <label for="reason" class="form-label">Detail/Reason <span class="text-danger">*</span></label>
                        <textarea id="reason" name="reason" rows="3" class="form-control" required 
                                  placeholder="Please provide detailed reason for your leave request..."></textarea>
                        <small class="text-muted" id="reason_help_text">Provide the reason for your leave request</small>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="hours_based" name="is_hours_based">
                        <label class="form-check-label" for="hours_based">
                            <strong>This leave is for specific hours (not full day)</strong>
                        </label>
                    </div>
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="multiple_dates" name="multiple_dates">
                        <label class="form-check-label" for="multiple_dates">
                            <strong>Leave dates are not consecutive</strong>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Single Date Section (default - consecutive dates) -->
            <div id="single_date_section">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="leave_date_single" class="form-label">Leave Date <span class="text-danger">*</span></label>
                            <input type="date" id="leave_date_single" name="leave_date_single" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="total_days" class="form-label">Total Days <span class="text-danger">*</span></label>
                            <input type="number" id="total_days" name="total_days" class="form-control" 
                                   value="1" min="1" step="1" required>
                            <small class="text-muted">Number of consecutive days</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Time Range (for hour-based leave) -->
            <div id="time_range_section" style="display: none;">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="leave_date_hours" class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" id="leave_date_hours" name="leave_date_hours" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <label for="start_time" class="form-label">Start Time <span class="text-danger">*</span></label>
                            <input type="time" id="start_time" name="start_time" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <label for="end_time" class="form-label">End Time <span class="text-danger">*</span></label>
                            <input type="time" id="end_time" name="end_time" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-3">
                            <label for="hours" class="form-label">Hours</label>
                            <input type="text" id="hours" name="hours" class="form-control" readonly>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Multiple Dates Section (for non-consecutive dates) -->
            <div id="multiple_dates_section" style="display: none;">
                <div class="row mb-2">
                    <div class="col-md-12">
                        <h5>Add Multiple Leave Dates</h5>
                        <p class="text-muted">Add each date separately for non-consecutive leave days.</p>
                    </div>
                </div>
                
                <div id="dates_container">
                    <div class="row date-row mb-2">
                        <div class="col-md-4">
                            <input type="date" name="leave_dates[]" class="form-control leave-date">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm remove-date">Remove</button>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-2">
                    <div class="col-md-12">
                        <button type="button" id="add_date" class="btn btn-info btn-sm">
                            <i class="bi bi-plus"></i> Add Another Date
                        </button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="multiple_total_days" class="form-label">Total Leave Days</label>
                            <input type="number" id="multiple_total_days" name="multiple_total_days" class="form-control" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden fields for database storage -->
            <input type="hidden" id="start_date" name="start_date">
            <input type="hidden" id="end_date" name="end_date">
        </div>
    </div>

    <!-- Approver Information Section -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-white">
            <h4><i class="bi bi-person-check"></i> Approver Information</h4>
        </div>
        <div class="card-body">
            {% if approver %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Your designated approver has been automatically selected. You can change it if needed.
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">Designated Approver</label>
                            <input type="text" class="form-control" value="{{ approver.full_name }}" readonly>
                            {% if approver.job_title %}
                                <small class="text-muted">{{ approver.job_title }} - {{ approver.approver_scope }}</small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">Email</label>
                            <input type="text" class="form-control" value="{{ approver.email }}" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- ALWAYS show the approver selection if there are available approvers -->
                {% if available_approvers|length > 0 %}
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="change_approver">
                    <label class="form-check-label" for="change_approver">
                        <strong>Select a different approver from your unit/section ({{ available_approvers|length }} available)</strong>
                    </label>
                </div>
                
                <div id="approver_selection_section" style="display: none;">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group mb-3">
                                <label for="manager_id" class="form-label">Available Approvers in Your Unit/Section <span class="text-danger">*</span></label>
                                <select id="manager_id" name="manager_id" class="form-select">
                                    <!-- Always include the designated approver as the first option -->
                                    <option value="{{ approver.id }}" selected
                                        data-email="{{ approver.email }}"
                                        data-signature="{{ approver.signature_path or '' }}">
                                        {{ approver.full_name }}
                                        {% if approver.job_title %} - {{ approver.job_title }}{% endif %}
                                        ({{ approver.approver_scope if approver.approver_scope else 'No Scope' }}) [Designated]
                                    </option>
                                    <!-- Add all other available approvers -->
                                    {% for manager in available_approvers %}
                                        {% if manager.is_active and manager.id != approver.id %}
                                        <option value="{{ manager.id }}"
                                            data-email="{{ manager.email }}"
                                            data-signature="{{ manager.signature_path or '' }}">
                                            {{ manager.full_name }}
                                            {% if manager.job_title %} - {{ manager.job_title }}{% endif %}
                                            ({{ manager.approver_scope if manager.approver_scope else 'No Scope' }})
                                            {% if manager.section_id == current_user.section_id %}[Same Section]{% endif %}
                                            {% if manager.unit_id == current_user.unit_id %}[Same Unit]{% endif %}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                
                                <!-- Hidden fields for approver selection -->
                                <input type="hidden" id="approver_email" name="approver_email" value="{{ approver.email }}">
                                <input type="hidden" id="approver_name" name="approver_name" value="{{ approver.full_name }}">
                                <input type="hidden" id="approver_id" name="approver_id" value="{{ approver.id }}">
                                <input type="hidden" id="appr_sign" name="appr_sign" value="{{ approver.signature_path or '' }}">
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>Only One Approver Available:</strong> No other approvers found in your unit/section.
                </div>
                <!-- Still need hidden fields for the designated approver -->
                <input type="hidden" id="manager_id" name="manager_id" value="{{ approver.id }}">
                <input type="hidden" id="approver_email" name="approver_email" value="{{ approver.email }}">
                <input type="hidden" id="approver_name" name="approver_name" value="{{ approver.full_name }}">
                <input type="hidden" id="approver_id" name="approver_id" value="{{ approver.id }}">
                <input type="hidden" id="appr_sign" name="appr_sign" value="{{ approver.signature_path or '' }}">
                {% endif %}
                
            {% else %}
                {% if available_approvers %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>No Designated Approver:</strong> You don't have a specific designated approver. Please select from {{ available_approvers|length }} available approvers in your unit/section below.
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group mb-3">
                            <label for="manager_id" class="form-label">Select Approver from Your Unit/Section <span class="text-danger">*</span></label>
                            <select id="manager_id" name="manager_id" required class="form-select">
                                <option value="" disabled selected>Select approver</option>
                                {% for manager in available_approvers %}
                                    {% if manager.is_active %}
                                    <option value="{{ manager.id }}"
                                        data-email="{{ manager.email }}"
                                        data-signature="{{ manager.signature_path or '' }}">
                                        {{ manager.full_name }}
                                        {% if manager.job_title %} - {{ manager.job_title }}{% endif %}
                                        ({{ manager.approver_scope if manager.approver_scope else 'No Scope' }})
                                        {% if manager.section_id == current_user.section_id %}[Same Section]{% endif %}
                                        {% if manager.unit_id == current_user.unit_id %}[Same Unit]{% endif %}
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            
                            <!-- Hidden fields for manual approver selection -->
                            <input type="hidden" id="approver_email" name="approver_email">
                            <input type="hidden" id="approver_name" name="approver_name">
                            <input type="hidden" id="approver_id" name="approver_id">
                            <input type="hidden" id="appr_sign" name="appr_sign">
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>No Available Approvers:</strong> There are no available approvers in your unit/section. 
                    Please contact your administrator to assign approvers before submitting leave requests.
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>        
    <div class="form-actions text-center mb-4">
        <button type="submit" class="btn btn-primary btn-lg me-3" {{ 'disabled' if not approver and not available_approvers }}>
            <i class="bi bi-send"></i> Submit Leave Request
        </button>
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary btn-lg">
            <i class="bi bi-x-circle"></i> Cancel
        </a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== LEAVE REQUEST FORM INITIALIZED ===');
    
    // ========================================
    // FORM INITIALIZATION
    // ========================================
    
    // Format and set current date
    const today = new Date();
    const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' +
                           today.getDate().toString().padStart(2, '0') + '/' +
                           today.getFullYear();
    document.getElementById('date_filed').value = formattedDate;
    
    // Generate placeholder reference code
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const numbers = '0123456789';
    let code = 'LV-';
    for (let i = 0; i < 10; i++) {
        const chars = letters + numbers;
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('unique_code').value = code;
    
    // ========================================
    // APPROVER SELECTION LOGIC - SINGLE IMPLEMENTATION
    // ========================================
    
    const approverCheckbox = document.getElementById('change_approver');
    const approverDropdownSection = document.getElementById('approver_selection_section');
    const managerSelectElement = document.getElementById('manager_id');
    
    console.log('🔍 Approver Elements Check:');
    console.log('  - Checkbox found:', !!approverCheckbox);
    console.log('  - Dropdown section found:', !!approverDropdownSection);
    console.log('  - Manager select found:', !!managerSelectElement);
    
    // Setup approver toggle functionality
    if (approverCheckbox && approverDropdownSection) {
        console.log('✅ Setting up approver toggle');
        
        approverCheckbox.addEventListener('change', function() {
            console.log('🔄 Approver toggle changed to:', this.checked);
            
            if (this.checked) {
                approverDropdownSection.style.display = 'block';
                console.log('👆 Showing approver dropdown');
            } else {
                approverDropdownSection.style.display = 'none';
                console.log('👇 Hiding approver dropdown');
                
                // Reset to designated approver (first option)
                if (managerSelectElement && managerSelectElement.options.length > 0) {
                    managerSelectElement.selectedIndex = 0;
                    managerSelectElement.dispatchEvent(new Event('change'));
                    console.log('🔄 Reset to designated approver');
                }
            }
        });
        
        // Test toggle functionality
        console.log('🧪 Testing toggle...');
        setTimeout(() => {
            approverCheckbox.checked = true;
            approverCheckbox.dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                approverCheckbox.checked = false;
                approverCheckbox.dispatchEvent(new Event('change'));
                console.log('✅ Toggle test completed');
            }, 1000);
        }, 500);
        
    } else {
        console.log('❌ Approver toggle elements missing');
        if (!approverCheckbox) console.log('  - Missing: change_approver checkbox');
        if (!approverDropdownSection) console.log('  - Missing: approver_selection_section div');
    }
    
    // Setup manager selection functionality
    if (managerSelectElement) {
        console.log('✅ Setting up manager selection');
        
        managerSelectElement.addEventListener('change', function() {
            console.log('📋 Manager selection changed');
            const selectedOption = this.options[this.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const approverEmail = selectedOption.dataset.email || '';
                const approverName = selectedOption.textContent.split(' - ')[0].split(' (')[0].trim();
                const approverId = selectedOption.value;
                const approverSignature = selectedOption.dataset.signature || '';
                
                console.log('📝 Updating hidden fields:', {
                    name: approverName,
                    email: approverEmail,
                    id: approverId
                });
                
                // Update hidden fields
                const emailField = document.getElementById('approver_email');
                const nameField = document.getElementById('approver_name');
                const idField = document.getElementById('approver_id');
                const signField = document.getElementById('appr_sign');
                
                if (emailField) emailField.value = approverEmail;
                if (nameField) nameField.value = approverName;
                if (idField) idField.value = approverId;
                if (signField) signField.value = approverSignature;
                
                console.log('✅ Hidden fields updated');
            }
        });
        
        // Trigger initial setup
        if (managerSelectElement.value) {
            managerSelectElement.dispatchEvent(new Event('change'));
        }
    }
    
    // ========================================
    // LEAVE TYPE AND WORK EXTENSIONS
    // ========================================
    
    // Handle leave type change
    const leaveTypeSelect = document.getElementById('leave_type');
    if (leaveTypeSelect) {
        leaveTypeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const requiresExtensions = selectedOption.dataset.requiresExtensions === 'true';
            
            // Show/hide work extensions section
            const extensionsSection = document.getElementById('work_extensions_section');
            const noExtensionsWarning = document.getElementById('no_extensions_warning');
            const reasonHelpText = document.getElementById('reason_help_text');
            
            if (requiresExtensions) {
                if (extensionsSection) {
                    extensionsSection.style.display = 'block';
                    if (reasonHelpText) reasonHelpText.textContent = 'Explain why you need to offset the selected work extensions';
                } else if (noExtensionsWarning) {
                    noExtensionsWarning.style.display = 'block';
                    if (reasonHelpText) reasonHelpText.textContent = 'You need approved work extensions to file "Other" leave type';
                }
            } else {
                if (extensionsSection) extensionsSection.style.display = 'none';
                if (noExtensionsWarning) noExtensionsWarning.style.display = 'none';
                if (reasonHelpText) reasonHelpText.textContent = 'Provide the reason for your leave request';
                
                // Clear selected work extensions
                document.querySelectorAll('.work-extension-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateExtensionsSummary();
            }
        });
    }
    
    // Handle work extension selection
    document.querySelectorAll('.work-extension-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateExtensionsSummary);
    });
    
    function updateExtensionsSummary() {
        const selectedCheckboxes = document.querySelectorAll('.work-extension-checkbox:checked');
        const summaryDiv = document.getElementById('selected_extensions_summary');
        const totalHoursInput = document.getElementById('total_extension_hours');
        
        if (!summaryDiv || !totalHoursInput) return;
        
        if (selectedCheckboxes.length === 0) {
            summaryDiv.innerHTML = '<small class="text-muted">No extensions selected</small>';
            totalHoursInput.value = '0 hours';
            return;
        }
        
        let summaryHTML = '';
        let totalHours = 0;
        
        selectedCheckboxes.forEach(checkbox => {
            const label = document.querySelector(`label[for="${checkbox.id}"]`);
            if (label) {
                const hours = parseFloat(checkbox.dataset.hours) || 0;
                const date = checkbox.dataset.date;
                const refCode = label.textContent.split(' - ')[0];
                
                summaryHTML += `<small class="d-block"><strong>${refCode}</strong> - ${date} (${hours}hrs)</small>`;
                totalHours += hours;
            }
        });
        
        summaryDiv.innerHTML = summaryHTML;
        totalHoursInput.value = `${totalHours.toFixed(1)} hours`;
    }
    
    // ========================================
    // DATE AND TIME HANDLING
    // ========================================
    
    // Initialize toggle sections based on checkboxes
    function updateToggleSections() {
        const hoursBasedChecked = document.getElementById('hours_based').checked;
        const multipleDatesChecked = document.getElementById('multiple_dates').checked;

        // Sections
        const singleDateSection = document.getElementById('single_date_section');
        const timeRangeSection = document.getElementById('time_range_section');
        const multipleDatesSection = document.getElementById('multiple_dates_section');

        // Required inputs
        const totalDaysInput = document.getElementById('total_days');
        const singleDateInput = document.getElementById('leave_date_single');

        if (!singleDateSection || !timeRangeSection || !multipleDatesSection) return;

        // Hide all sections and remove required attributes
        singleDateSection.style.display = 'none';
        timeRangeSection.style.display = 'none';
        multipleDatesSection.style.display = 'none';
        
        if (totalDaysInput) totalDaysInput.removeAttribute('required');
        if (singleDateInput) singleDateInput.removeAttribute('required');

        if (hoursBasedChecked) {
            timeRangeSection.style.display = 'block';
        } else if (multipleDatesChecked) {
            multipleDatesSection.style.display = 'block';
        } else {
            singleDateSection.style.display = 'block';
            if (totalDaysInput) totalDaysInput.setAttribute('required', 'required');
            if (singleDateInput) singleDateInput.setAttribute('required', 'required');
        }
        
        updateDatabaseFields();
        updateTotalDaysForSubmission();
    }

    function formatDateMMDDYYYY(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const year = date.getFullYear();
        
        return `${month}/${day}/${year}`;
    }

    function formatTime(timeString) {
        if (!timeString) return '';
        return timeString;
    }
    
    // Update the correct total days for form submission
    function updateTotalDaysForSubmission() {
        const hoursBasedChecked = document.getElementById('hours_based').checked;
        const multipleDatesChecked = document.getElementById('multiple_dates').checked;
        
        // Create hidden inputs for backend if they don't exist
        let multipleTotalDaysInput = document.getElementById('multiple_total_days_hidden');
        let hoursInput = document.getElementById('hours_hidden');
        
        if (!multipleTotalDaysInput) {
            multipleTotalDaysInput = document.createElement('input');
            multipleTotalDaysInput.type = 'hidden';
            multipleTotalDaysInput.id = 'multiple_total_days_hidden';
            multipleTotalDaysInput.name = 'multiple_total_days';
            const form = document.querySelector('form');
            if (form) form.appendChild(multipleTotalDaysInput);
        }
        
        if (!hoursInput) {
            hoursInput = document.createElement('input');
            hoursInput.type = 'hidden';
            hoursInput.id = 'hours_hidden';
            hoursInput.name = 'hours';
            const form = document.querySelector('form');
            if (form) form.appendChild(hoursInput);
        }
        
        if (hoursBasedChecked) {
            const calculatedHoursElement = document.getElementById('hours');
            const calculatedHours = calculatedHoursElement ? calculatedHoursElement.value : '0';
            hoursInput.value = calculatedHours || '0';
            multipleTotalDaysInput.value = '';
        } else if (multipleDatesChecked) {
            const dateInputs = document.querySelectorAll('.leave-date');
            const validDates = Array.from(dateInputs).filter(input => input.value !== '');
            multipleTotalDaysInput.value = validDates.length;
            hoursInput.value = '';
        } else {
            multipleTotalDaysInput.value = '';
            hoursInput.value = '';
        }
    }
    
    function updateDatabaseFields() {
        const hoursBasedChecked = document.getElementById('hours_based').checked;
        const multipleDatesChecked = document.getElementById('multiple_dates').checked;
        
        const startDateField = document.getElementById('start_date');
        const endDateField = document.getElementById('end_date');
        
        if (!startDateField || !endDateField) return;
        
        if (hoursBasedChecked) {
            const leaveDateElement = document.getElementById('leave_date_hours');
            const startTimeElement = document.getElementById('start_time');
            const endTimeElement = document.getElementById('end_time');
            
            if (leaveDateElement && startTimeElement && endTimeElement) {
                const leaveDate = leaveDateElement.value;
                const startTime = startTimeElement.value;
                const endTime = endTimeElement.value;
                
                if (leaveDate && startTime && endTime) {
                    const formattedDate = formatDateMMDDYYYY(leaveDate);
                    const formattedStartTime = formatTime(startTime);
                    const formattedEndTime = formatTime(endTime);
                    
                    const concatenatedValue = `${formattedDate} ${formattedStartTime} - ${formattedEndTime}`;
                    startDateField.value = concatenatedValue;
                } else {
                    startDateField.value = '';
                }
            }
            endDateField.value = '';
            
        } else if (multipleDatesChecked) {
            const dateInputs = document.querySelectorAll('.leave-date');
            const validDates = Array.from(dateInputs)
                .map(input => input.value)
                .filter(date => date !== '')
                .map(date => formatDateMMDDYYYY(date));
            
            if (validDates.length > 0) {
                const concatenatedDates = validDates.join(',');
                startDateField.value = concatenatedDates;
            } else {
                startDateField.value = '';
            }
            endDateField.value = '';
            
        } else {
            const singleDateElement = document.getElementById('leave_date_single');
            if (singleDateElement) {
                const singleDate = singleDateElement.value;
                if (singleDate) {
                    startDateField.value = formatDateMMDDYYYY(singleDate);
                } else {
                    startDateField.value = '';
                }
            }
            endDateField.value = '';
        }
        
        updateTotalDaysForSubmission();
    }
    
    // Calculate hours for time-based leave
    function calculateHours() {
        const startTimeElement = document.getElementById('start_time');
        const endTimeElement = document.getElementById('end_time');
        const hoursElement = document.getElementById('hours');
        
        if (!startTimeElement || !endTimeElement || !hoursElement) return;
        
        const startTime = startTimeElement.value;
        const endTime = endTimeElement.value;
        
        if (startTime && endTime) {
            const start = new Date(`2023-01-01T${startTime}:00`);
            const end = new Date(`2023-01-01T${endTime}:00`);
            
            if (end > start) {
                const diff = (end - start) / (1000 * 60 * 60);
                hoursElement.value = diff.toFixed(1);
            } else {
                hoursElement.value = '0';
            }
        }
        updateTotalDaysForSubmission();
    }
    
    // ========================================
    // EVENT LISTENERS SETUP
    // ========================================
    
    // Run once when page loads
    updateToggleSections();
    
    // Add event listeners for checkbox changes
    const hoursBasedElement = document.getElementById('hours_based');
    const multipleDatesElement = document.getElementById('multiple_dates');
    
    if (hoursBasedElement) {
        hoursBasedElement.addEventListener('change', function() {
            if (this.checked && multipleDatesElement) {
                multipleDatesElement.checked = false;
            }
            updateToggleSections();
        });
    }
    
    if (multipleDatesElement) {
        multipleDatesElement.addEventListener('change', function() {
            if (this.checked && hoursBasedElement) {
                hoursBasedElement.checked = false;
            }
            updateToggleSections();
        });
    }
    
    // Add event listeners for date/time changes
    const leaveDateSingleElement = document.getElementById('leave_date_single');
    const leaveDateHoursElement = document.getElementById('leave_date_hours');
    const startTimeElement = document.getElementById('start_time');
    const endTimeElement = document.getElementById('end_time');
    const totalDaysElement = document.getElementById('total_days');
    
    if (leaveDateSingleElement) {
        leaveDateSingleElement.addEventListener('change', updateDatabaseFields);
    }
    
    if (leaveDateHoursElement) {
        leaveDateHoursElement.addEventListener('change', updateDatabaseFields);
    }
    
    if (startTimeElement) {
        startTimeElement.addEventListener('change', function() {
            calculateHours();
            updateDatabaseFields();
        });
    }
    
    if (endTimeElement) {
        endTimeElement.addEventListener('change', function() {
            calculateHours();
            updateDatabaseFields();
        });
    }
    
    if (totalDaysElement) {
        totalDaysElement.addEventListener('change', updateTotalDaysForSubmission);
    }
    
    // ========================================
    // MULTIPLE DATES HANDLING
    // ========================================
    
    // Handle multiple dates
    const addDateButton = document.getElementById('add_date');
    if (addDateButton) {
        addDateButton.addEventListener('click', function() {
            const container = document.getElementById('dates_container');
            if (!container) return;
            
            const newRow = document.createElement('div');
            newRow.className = 'row date-row mb-2';
            newRow.innerHTML = `
                <div class="col-md-4">
                    <input type="date" name="leave_dates[]" class="form-control leave-date">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm remove-date">Remove</button>
                </div>
            `;
            
            container.appendChild(newRow);
            
            const removeButton = newRow.querySelector('.remove-date');
            const dateInput = newRow.querySelector('.leave-date');
            
            if (removeButton) {
                removeButton.addEventListener('click', function() {
                    container.removeChild(newRow);
                    updateMultipleDaysCount();
                });
            }
            
            if (dateInput) {
                dateInput.addEventListener('change', function() {
                    updateMultipleDaysCount();
                    updateDatabaseFields();
                });
            }
        });
    }
    
    // Event delegation for remove buttons
    const datesContainer = document.getElementById('dates_container');
    if (datesContainer) {
        datesContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-date')) {
                const row = e.target.closest('.date-row');
                if (row) {
                    row.parentNode.removeChild(row);
                    updateMultipleDaysCount();
                    updateDatabaseFields();
                }
            }
        });
    }
    
    function updateMultipleDaysCount() {
        const dateInputs = document.querySelectorAll('.leave-date');
        const validDates = Array.from(dateInputs).filter(input => input.value !== '');
        const multipleTotalDaysElement = document.getElementById('multiple_total_days');
        if (multipleTotalDaysElement) {
            multipleTotalDaysElement.value = validDates.length;
        }
        updateDatabaseFields();
    }
    
    // ========================================
    // FORM VALIDATION
    // ========================================
    
    // Form validation
    const formElement = document.querySelector('form');
    if (formElement) {
        formElement.addEventListener('submit', function(e) {
            updateDatabaseFields();
            updateTotalDaysForSubmission();
            
            let isValid = true;
            let errorMessage = '';
            
            const leaveTypeElement = document.getElementById('leave_type');
            if (!leaveTypeElement || !leaveTypeElement.value) {
                isValid = false;
                errorMessage = 'Please select a leave type';
            }
            
            // Special validation for "Other" leave type
            if (leaveTypeElement && leaveTypeElement.value === 'Other') {
                const selectedExtensions = document.querySelectorAll('.work-extension-checkbox:checked');
                if (selectedExtensions.length === 0) {
                    isValid = false;
                    errorMessage = 'Please select at least one approved work extension for "Other" leave type';
                }
            }
            
            const reasonElement = document.getElementById('reason');
            if (!reasonElement || !reasonElement.value.trim()) {
                isValid = false;
                errorMessage = 'Please provide a reason for your leave';
            }
            
            const contactElement = document.getElementById('contact');
            if (!contactElement || !contactElement.value.trim()) {
                isValid = false;
                errorMessage = 'Please provide a contact number';
            }
            
            // Check if approver is selected (for manual selection case)
            if (managerSelectElement && managerSelectElement.tagName === 'SELECT' && !managerSelectElement.value) {
                isValid = false;
                errorMessage = 'Please select an approver';
            }
            
            if (!isValid) {
                alert(errorMessage);
                e.preventDefault();
            }
        });
    }
    
    console.log('✅ Leave request form initialization completed');
});
</script>
{% endblock %}
