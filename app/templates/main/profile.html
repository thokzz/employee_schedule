{% extends "base.html" %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">User Profile</h1>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Personal Information -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Personal Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.update_profile') }}" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="first_name" name="first_name" 
                                       value="{{ current_user.first_name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="last_name" name="last_name" 
                                       value="{{ current_user.last_name }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" name="email" 
                               value="{{ current_user.email }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="avatar" class="form-label">Avatar</label>
                        <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*">
                        <small class="text-muted">Upload a new avatar image (optional)</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Update Personal Information</button>
                </form>
            </div>
        </div>

        <!-- Employment Information -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Employment Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.update_employment_info') }}">
                    <!-- Basic Employment Details -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="personnel_number" class="form-label">Personnel Number</label>
                                <input type="text" class="form-control" id="personnel_number" name="personnel_number" 
                                       value="{{ current_user.personnel_number or '' }}"
                                       placeholder="e.g., Based on Worksched information">
                                <small class="text-muted">Unique employee identification number</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="typecode" class="form-label">Type Code</label>
                                <input type="text" class="form-control" id="typecode" name="typecode" 
                                       value="{{ current_user.typecode or '' }}"
                                       placeholder="e.g., Based on Worksched information">
                                <small class="text-muted">Employment type code</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Employee Type and Schedule Format -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="employee_type" class="form-label">Employee Type</label>
                                <select class="form-select" id="employee_type" name="employee_type">
                                    <option value="rank_and_file" {% if current_user.employee_type and current_user.employee_type.value == 'rank_and_file' %}selected{% endif %}>Rank and File</option>
                                    <option value="rank_and_file_probationary" {% if current_user.employee_type and current_user.employee_type.value == 'rank_and_file_probationary' %}selected{% endif %}>Rank and File Probationary</option>
                                    <option value="confidential" {% if current_user.employee_type and current_user.employee_type.value == 'confidential' %}selected{% endif %}>Confidential</option>
                                    <option value="confidential_probationary" {% if current_user.employee_type and current_user.employee_type.value == 'confidential_probationary' %}selected{% endif %}>Confidential Probationary</option>
                                    <option value="contractual" {% if current_user.employee_type and current_user.employee_type.value == 'contractual' %}selected{% endif %}>Contractual</option>
                                </select>
                                <small class="text-muted">Employee classification type</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedule_format" class="form-label">Regular Schedule Format</label>
                                <select class="form-select" id="schedule_format" name="schedule_format">
                                    <option value="8_hour_shift" {% if current_user.schedule_format and current_user.schedule_format.value == '8_hour_shift' %}selected{% endif %}>8-hour shift (30 min break)</option>
                                    <option value="9_hour_shift" {% if current_user.schedule_format and current_user.schedule_format.value == '9_hour_shift' %}selected{% endif %}>9-hour shift (1 hour break)</option>
                                    <option value="others" {% if current_user.schedule_format and current_user.schedule_format.value == 'others' %}selected{% endif %}>Others</option>
                                </select>
                                <small class="text-muted">Default work schedule format for break calculations</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_number" class="form-label">ID Number</label>
                                <input type="text" class="form-control" id="id_number" name="id_number" 
                                       value="{{ current_user.id_number or '' }}"
                                       placeholder="e.g., Employee ID Number">
                                <small class="text-muted">Government or company issued ID</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hiring_date" class="form-label">Hiring Date</label>
                                <input type="date" class="form-control" id="hiring_date" name="hiring_date" 
                                       value="{{ current_user.hiring_date.isoformat() if current_user.hiring_date else '' }}">
                                <small class="text-muted">Date when employment started</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="job_title" class="form-label">Job Title</label>
                                <input type="text" class="form-control" id="job_title" name="job_title" 
                                       value="{{ current_user.job_title or '' }}"
                                       placeholder="e.g., Senior Developer">
                                <small class="text-muted">Current position or job title</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="rank" class="form-label">Rank</label>
                                <input type="text" class="form-control" id="rank" name="rank" 
                                       value="{{ current_user.rank or '' }}"
                                       placeholder="e.g., RF3, CONFI B">
                                <small class="text-muted">Employee rank or level</small>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">Update Employment Information</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Profile Summary -->
        <div class="card">
            <div class="card-body text-center">
                <div class="employee-initials mx-auto mb-3" style="width: 80px; height: 80px; font-size: 1.5rem;">
                    {{ current_user.initials }}
                </div>
                <h5 class="card-title">{{ current_user.full_name }}</h5>
                <p class="card-text text-muted">{{ current_user.role.value.title() }}</p>
                {% if current_user.job_title %}
                    <p class="card-text"><small class="text-primary">{{ current_user.job_title }}</small></p>
                {% endif %}
                {% if current_user.section %}
                    <p class="card-text"><small class="text-muted">{{ current_user.section.name }}</small></p>
                {% endif %}
                {% if current_user.unit %}
                    <p class="card-text"><small class="text-muted">{{ current_user.unit.name }}</small></p>
                {% endif %}
                <p class="card-text"><small class="text-muted">Member since {{ current_user.created_at.strftime('%B %Y') }}</small></p>
            </div>
        </div>
        
        <!-- Employment Details -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Employment Details</h6>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Personnel #:</strong>
                    </div>
                    <div class="col-6">
                        {{ current_user.personnel_number or 'Not set' }}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Employee Type:</strong>
                    </div>
                    <div class="col-6">
                        {% if current_user.employee_type %}
                            <span class="badge bg-{{ 'warning' if current_user.employee_type.value == 'confidential' else 'info' if current_user.employee_type.value == 'contractual' else 'primary' }}">
                                {{ current_user.employee_type.value.replace('_', ' ').title() }}
                            </span>
                        {% else %}
                            Not set
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Schedule Format:</strong>
                    </div>
                    <div class="col-6">
                        {% if current_user.schedule_format %}
                            <span class="badge bg-{{ 'success' if current_user.schedule_format.value == '8_hour_shift' else 'warning' if current_user.schedule_format.value == '9_hour_shift' else 'secondary' }}">
                                {% if current_user.schedule_format.value == '8_hour_shift' %}
                                    8-hour (30min break)
                                {% elif current_user.schedule_format.value == '9_hour_shift' %}
                                    9-hour (1hr break)
                                {% else %}
                                    Others
                                {% endif %}
                            </span>
                        {% else %}
                            Not set
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Type Code:</strong>
                    </div>
                    <div class="col-6">
                        {% if current_user.typecode %}
                            <span class="badge bg-secondary">{{ current_user.typecode }}</span>
                        {% else %}
                            Not set
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>ID Number:</strong>
                    </div>
                    <div class="col-6">
                        {% if current_user.id_number %}
                            <span class="font-monospace">{{ current_user.id_number[:4] }}***</span>
                        {% else %}
                            Not set
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Hired:</strong>
                    </div>
                    <div class="col-6">
                        {% if current_user.hiring_date %}
                            {{ current_user.hiring_date.strftime('%b %d, %Y') }}
                        {% else %}
                            Not set
                        {% endif %}
                    </div>
                </div>
                {% if current_user.years_of_service %}
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Service:</strong>
                    </div>
                    <div class="col-6">
                        <span class="badge bg-success">{{ current_user.years_of_service }} years</span>
                    </div>
                </div>
                {% endif %}
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Rank:</strong>
                    </div>
                    <div class="col-6">
                        {% if current_user.rank %}
                            <span class="badge bg-info">{{ current_user.rank }}</span>
                        {% else %}
                            Not set
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Account Details -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Account Details</h6>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Username:</strong>
                    </div>
                    <div class="col-6">
                        {{ current_user.username }}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Status:</strong>
                    </div>
                    <div class="col-6">
                        <span class="badge bg-{{ 'success' if current_user.is_active else 'danger' }}">
                            {{ 'Active' if current_user.is_active else 'Inactive' }}
                        </span>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <strong>Last Updated:</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">{{ current_user.updated_at.strftime('%b %d, %Y') }}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('schedule.view_schedule') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-calendar3"></i> View My Schedule
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" onclick="changePassword()">
                        <i class="bi bi-key"></i> Change Password
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="downloadProfile()">
                        <i class="bi bi-download"></i> Download Profile
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.change_password') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required>
                        <small class="text-muted">Minimum 6 characters</small>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function changePassword() {
    new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
}

function downloadProfile() {
    // Generate a comprehensive profile summary
    const profileData = {
        name: '{{ current_user.full_name }}',
        username: '{{ current_user.username }}',
        email: '{{ current_user.email }}',
        role: '{{ current_user.role.value.title() }}',
        personnel_number: '{{ current_user.personnel_number or "" }}',
        employee_type: '{{ current_user.employee_type.value.replace("_", " ").title() if current_user.employee_type else "" }}',
        schedule_format: '{{ current_user.schedule_format.value.replace("_", " ").title() if current_user.schedule_format else "" }}',
        typecode: '{{ current_user.typecode or "" }}',
        job_title: '{{ current_user.job_title or "" }}',
        rank: '{{ current_user.rank or "" }}',
        hiring_date: '{{ current_user.hiring_date.strftime("%Y-%m-%d") if current_user.hiring_date else "" }}',
        section: '{{ current_user.section.name if current_user.section else "" }}',
        unit: '{{ current_user.unit.name if current_user.unit else "" }}'
    };
    
    const content = `Employee Profile Summary
=========================

Personal Information:
- Name: ${profileData.name}
- Username: ${profileData.username}
- Email: ${profileData.email}

Employment Information:
- Role: ${profileData.role}
- Employee Type: ${profileData.employee_type || 'Not set'}
- Schedule Format: ${profileData.schedule_format || 'Not set'}
- Personnel Number: ${profileData.personnel_number || 'Not set'}
- Type Code: ${profileData.typecode || 'Not set'}
- Job Title: ${profileData.job_title || 'Not set'}
- Rank: ${profileData.rank || 'Not set'}
- Hiring Date: ${profileData.hiring_date || 'Not set'}
- Section: ${profileData.section || 'Not assigned'}
- Unit: ${profileData.unit || 'Not assigned'}

Generated on: ${new Date().toLocaleString()}
`;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${profileData.username}_profile.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Password validation
document.getElementById('new_password')?.addEventListener('input', function() {
    const password = this.value;
    
    if (password.length > 0) {
        if (password.length >= 6) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    } else {
        this.classList.remove('is-valid', 'is-invalid');
    }
});

// Confirm password validation
document.getElementById('confirm_password')?.addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;
    
    if (confirmPassword.length > 0) {
        if (confirmPassword === newPassword) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    } else {
        this.classList.remove('is-valid', 'is-invalid');
    }
});

// Auto-format personnel number
document.getElementById('personnel_number')?.addEventListener('input', function() {
    let value = this.value.toUpperCase();
    this.value = value;
});

// Auto-format type code
document.getElementById('typecode')?.addEventListener('input', function() {
    let value = this.value.toUpperCase();
    this.value = value;
});

// Hiring date validation
document.getElementById('hiring_date')?.addEventListener('change', function() {
    const hiringDate = new Date(this.value);
    const today = new Date();
    
    if (hiringDate > today) {
        this.classList.add('is-invalid');
        this.setCustomValidity('Hiring date cannot be in the future');
    } else {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
        this.setCustomValidity('');
    }
});

// Schedule format info tooltip
document.getElementById('schedule_format')?.addEventListener('change', function() {
    const value = this.value;
    let info = '';
    
    if (value === '8_hour_shift') {
        info = 'Employees with 8-hour shifts get 30-minute paid breaks';
    } else if (value === '9_hour_shift') {
        info = 'Employees with 9-hour shifts get 1-hour paid breaks';
    } else {
        info = 'Other schedule formats default to 30-minute breaks';
    }
    
    // You could show this info in a tooltip or small text element
    console.log(info);
});
</script>
{% endblock %}