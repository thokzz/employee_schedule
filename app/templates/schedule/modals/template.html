<!-- Template Management Modal - UPDATED with BLANK Template Integration -->
<div class="modal fade" id="templateManagementModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-files"></i> Schedule Templates
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Template Actions Tabs - UPDATED -->
                <ul class="nav nav-tabs mb-3" id="templateTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="browse-tab" data-bs-toggle="tab" data-bs-target="#browse-templates">
                            <i class="bi bi-search"></i> Browse Templates
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-template">
                            <i class="bi bi-camera"></i> Create Snapshot
                        </button>
                    </li>
                    <!-- NEW: BLANK Template Tab -->
                    <li class="nav-item">
                        <button class="nav-link" id="create-blank-tab" data-bs-toggle="tab" data-bs-target="#create-blank-template">
                            <i class="bi bi-eraser text-warning"></i> Create BLANK
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Browse Templates Tab - UNCHANGED -->
                    <div class="tab-pane fade show active" id="browse-templates">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="input-group" style="max-width: 300px;">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="templateSearch" placeholder="Search templates...">
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary btn-sm active" onclick="filterTemplates('all')">All</button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="filterTemplates('mine')">My Templates</button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="filterTemplates('public')">Public</button>
                            </div>
                        </div>

                        <div id="templatesGrid" class="row">
                            <!-- Templates will be loaded here -->
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading templates...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create Template Tab - UNCHANGED -->
                    <div class="tab-pane fade" id="create-template">
                        <form id="createTemplateForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Template Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="name" required placeholder="e.g., Standard Weekly Schedule">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" name="description" rows="3" placeholder="Describe when and how this template should be used..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" name="is_public" id="templatePublic">
                                            <label class="form-check-label" for="templatePublic">
                                                <i class="bi bi-globe"></i> Make template public (others can use it)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Source Date Range <span class="text-danger">*</span></label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="date" class="form-control" name="start_date" required>
                                                <small class="text-muted">Start Date</small>
                                            </div>
                                            <div class="col-6">
                                                <input type="date" class="form-control" name="end_date" required>
                                                <small class="text-muted">End Date</small>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">Maximum 14 days allowed</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Organizational Scope</label>
                                        <select class="form-select" name="scope_type" onchange="updateScopeOptions()">
                                            <option value="">Use Current User's Scope</option>
                                            <option value="department">Department</option>
                                            <option value="division">Division</option>
                                            <option value="section">Section</option>
                                            <option value="unit">Unit</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="scopeSelection" style="display: none;">
                                        <select class="form-select" name="scope_id">
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Snapshot Creation:</strong> This will capture all shifts in the selected date range and organizational scope, creating a reusable template pattern.
                            </div>
                        </form>
                    </div>

                    <!-- NEW: Create BLANK Template Tab -->
                    <div class="tab-pane fade" id="create-blank-template">
                        <form id="createBlankTemplateForm">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>BLANK Template:</strong> This creates a template that clears all existing shifts in a specified date range. Use this to create clean slate periods for new schedule planning.
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-shield-check"></i>
                                <strong>Security Note:</strong> You can only create BLANK templates for your own section or unit. This prevents accidental clearing of other departments' schedules.
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Template Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="name" required placeholder="e.g., Clear Week for Planning">
                                        <small class="form-text text-muted">Choose a descriptive name that indicates this clears schedules</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" name="description" rows="3" placeholder="Describe the purpose of this BLANK template..."></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" name="is_public" id="blankTemplatePublic">
                                            <label class="form-check-label" for="blankTemplatePublic">
                                                <i class="bi bi-globe"></i> Make template public (others in your organization can use it)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Duration (Days) <span class="text-danger">*</span></label>
                                        <select class="form-select" name="duration_days" required>
                                            <option value="">Select duration...</option>
                                            <option value="1">1 Day</option>
                                            <option value="2">2 Days</option>
                                            <option value="3">3 Days</option>
                                            <option value="5">5 Days (Weekdays)</option>
                                            <option value="7" selected>7 Days (1 Week)</option>
                                            <option value="14">14 Days (2 Weeks)</option>
                                        </select>
                                        <small class="form-text text-muted">How many consecutive days will this template clear</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Organizational Scope</label>
                                        <select class="form-select" name="scope_type" onchange="updateBlankScopeOptions()">
                                            <option value="">Use Your Current Scope</option>
                                            <option value="section">Your Section</option>
                                            <option value="unit">Your Unit</option>
                                        </select>
                                        <small class="form-text text-muted">You can only create BLANK templates for your own organizational scope</small>
                                    </div>
                                    
                                    <div class="mb-3" id="blankScopeSelection" style="display: none;">
                                        <select class="form-select" name="scope_id">
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                    
                                    <div id="blankCurrentScope" class="small text-muted">
                                        <!-- Will show user's current scope -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card border-warning">
                                <div class="card-header bg-warning bg-opacity-10">
                                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> How BLANK Templates Work</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li><strong>Purpose:</strong> Clear existing shifts to create clean scheduling periods</li>
                                        <li><strong>Scope:</strong> Only affects your section or unit members</li>
                                        <li><strong>Safety:</strong> Option to preserve important leave types (vacation, sick leave)</li>
                                        <li><strong>Usage:</strong> Perfect for schedule redesigns, holiday periods, or fresh starts</li>
                                    </ul>
                                    
                                    <div class="mt-3">
                                        <h6 class="text-warning">⚠️ Important Warnings:</h6>
                                        <ul class="text-muted small mb-0">
                                            <li>BLANK templates permanently delete existing shifts</li>
                                            <li>This action cannot be undone once applied</li>
                                            <li>Always backup important schedules before clearing</li>
                                            <li>Consider preserving approved leave applications</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="templateActions">
                    <!-- Action buttons will appear here based on active tab -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Apply Template Modal -->
<div class="modal fade" id="applyTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat"></i> Apply Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Template Info -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0" id="selectedTemplateName">Template Name</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Duration:</small><br>
                                <span id="templateDuration">7 days</span>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Employees:</small><br>
                                <span id="templateEmployees">15 employees</span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <small class="text-muted">Shifts:</small><br>
                                <span id="templateShifts">105 shifts</span>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Scope:</small><br>
                                <span id="templateScope">Section: IT Department</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Application Form -->
                <form id="applyTemplateForm">
                    <input type="hidden" name="template_id" id="applyTemplateId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Target Date Range <span class="text-danger">*</span></label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="date" class="form-control" name="target_start_date" required>
                                        <small class="text-muted">Start Date</small>
                                    </div>
                                    <div class="col-6">
                                        <input type="date" class="form-control" name="target_end_date" required>
                                        <small class="text-muted">End Date</small>
                                    </div>
                                </div>
                                <small class="form-text text-muted">Must match template duration</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Target Organizational Unit</label>
                                <select class="form-select" name="target_scope_type" onchange="updateTargetScopeOptions()">
                                    <option value="">Use Template's Original Scope</option>
                                    <option value="section">Section</option>
                                    <option value="unit">Unit</option>
                                </select>
                            </div>
                            <div class="mb-3" id="targetScopeSelection" style="display: none;">
                                <select class="form-select" name="target_scope_id">
                                    <!-- Options populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="replace_existing" id="replaceExisting">
                            <label class="form-check-label" for="replaceExisting">
                                <i class="bi bi-arrow-clockwise"></i> Replace existing shifts in target date range
                            </label>
                        </div>
                        <small class="form-text text-muted">If unchecked, will skip dates that already have shifts</small>
                    </div>

                    <!-- Preview Section -->
                    <div id="applicationPreview" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-eye"></i> Application Preview</h6>
                            </div>
                            <div class="card-body">
                                <div id="previewContent">
                                    <!-- Preview content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" onclick="generatePreview()">
                    <i class="bi bi-eye"></i> Preview
                </button>
                <button type="button" class="btn btn-primary" onclick="applySelectedTemplate()">
                    <i class="bi bi-check"></i> Apply Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Apply Template Modal - UNCHANGED -->
<div class="modal fade" id="quickApplyTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-lightning"></i> Quick Apply Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Template <span class="text-danger">*</span></label>
                    <select class="form-select" id="quickTemplateSelect" required>
                        <option value="">Choose a template...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Target Start Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="quickTargetDate" required>
                    <small class="form-text text-muted">Template will be applied starting from this date</small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="quickReplaceExisting">
                    <label class="form-check-label" for="quickReplaceExisting">
                        <i class="bi bi-arrow-clockwise"></i> Replace existing shifts
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="quickApplyTemplate()">
                    <i class="bi bi-check"></i> Apply
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Function to update blank template scope options (restrict to user's scope)
function updateBlankScopeOptions() {
    const scopeType = document.querySelector('#create-blank-template select[name="scope_type"]').value;
    const scopeSelection = document.getElementById('blankScopeSelection');
    const scopeSelect = document.querySelector('#create-blank-template select[name="scope_id"]');
    const currentScopeDiv = document.getElementById('blankCurrentScope');
    
    if (!scopeType || !templateManager?.organizationalScope) {
        scopeSelection.style.display = 'none';
        return;
    }
    
    scopeSelection.style.display = 'block';
    
    let options = '<option value="">Select...</option>';
    const currentUser = window.currentUser;
    const isAdmin = currentUser && currentUser.role === 'administrator';
    const userScope = templateManager.organizationalScope.current_user_scope;
    
    switch (scopeType) {
        case 'section':
            if (templateManager.organizationalScope.sections && userScope.section_id) {
                const userSection = templateManager.organizationalScope.sections.find(s => s.id === userScope.section_id);
                if (userSection) {
                    options += `<option value="${userSection.id}" selected>${templateManager.escapeHtml(userSection.name)}</option>`;
                    currentScopeDiv.innerHTML = `<i class="bi bi-building"></i> Your Section: ${templateManager.escapeHtml(userSection.name)}`;
                } else {
                    currentScopeDiv.innerHTML = '<span class="text-warning">⚠️ You don\'t belong to any section</span>';
                }
            }
            break;
            
        case 'unit':
            if (templateManager.organizationalScope.units && userScope.unit_id) {
                const userUnit = templateManager.organizationalScope.units.find(u => u.id === userScope.unit_id);
                if (userUnit) {
                    options += `<option value="${userUnit.id}" selected>${templateManager.escapeHtml(userUnit.name)}</option>`;
                    currentScopeDiv.innerHTML = `<i class="bi bi-people"></i> Your Unit: ${templateManager.escapeHtml(userUnit.name)}`;
                } else {
                    currentScopeDiv.innerHTML = '<span class="text-warning">⚠️ You don\'t belong to any unit</span>';
                }
            }
            break;
    }
    
    scopeSelect.innerHTML = options;
    
    // Show security warning for non-admins
    if (!isAdmin) {
        const warning = `<br><small class="text-warning"><i class="bi bi-shield-exclamation"></i> Security: You can only create BLANK templates for your own ${scopeType}</small>`;
        currentScopeDiv.innerHTML += warning;
    }
}

// Auto-show user's current scope on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const currentScopeDiv = document.getElementById('blankCurrentScope');
        if (currentScopeDiv && window.currentUser) {
            const userScope = templateManager?.organizationalScope?.current_user_scope;
            if (userScope) {
                let scopeInfo = '<i class="bi bi-person-badge"></i> Your Current Access: ';
                if (userScope.section_id) {
                    scopeInfo += 'Section-level access';
                } else if (userScope.unit_id) {
                    scopeInfo += 'Unit-level access';
                } else {
                    scopeInfo += 'Limited access - contact admin';
                }
                currentScopeDiv.innerHTML = scopeInfo;
            }
        }
    }, 1000);
});
</script>
