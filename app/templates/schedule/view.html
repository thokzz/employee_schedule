{% extends "base.html" %}

{% block title %}Schedule{% endblock %}

{% block extra_css %}
<style>
.color-picker-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    max-width: 250px;
}

.color-option {
    width: 35px;
    height: 35px;
    border-radius: 8px;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s ease;
    position: relative;
}

.color-option:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.color-option.selected {
    border-color: #000;
    transform: scale(1.15);
    box-shadow: 0 0 0 2px #fff, 0 0 0 4px #000;
}

.color-option::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 18px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.color-option.selected::after {
    opacity: 1;
}

/* For light colors, use dark checkmark */
.color-option[data-color="#fff3cd"]::after,
.color-option[data-color="#f8d7da"]::after,
.color-option[data-color="#d1ecf1"]::after,
.color-option[data-color="#d4edda"]::after,
.color-option[data-color="#dee2e6"]::after,
.color-option[data-color="#ffc107"]::after {
    color: #000;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
}
</style>
{% endblock %}

{% block content %}
<!-- Schedule Header -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
    <h1 class="h2 mb-3 mb-md-0">Schedule</h1>
    
    <div class="d-flex flex-wrap gap-2">
        <!-- View Toggle -->
        <div class="btn-group" role="group">
            <a href="{{ url_for('schedule.view_schedule', view='day', date=selected_date) }}" 
               class="btn btn-sm {% if view_type == 'day' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                Day
            </a>
            <a href="{{ url_for('schedule.view_schedule', view='week', date=selected_date) }}" 
               class="btn btn-sm {% if view_type == 'week' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                Week
            </a>
            <a href="{{ url_for('schedule.view_schedule', view='month', date=selected_date) }}" 
               class="btn btn-sm {% if view_type == 'month' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                Month
            </a>
        </div>
        
        <!-- Date Navigation -->
        <div class="btn-group" role="group">
            <button class="btn btn-outline-secondary btn-sm" onclick="navigateDate(-1)">
                <i class="bi bi-chevron-left"></i>
            </button>
            <input type="date" id="date-picker" class="form-control form-control-sm" 
                   value="{{ selected_date.isoformat() }}" onchange="navigateToDate(this.value)">
            <button class="btn btn-outline-secondary btn-sm" onclick="navigateDate(1)">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        
        {% if can_edit %}
        <button class="btn btn-success btn-sm" onclick="publishSchedule()">
            <i class="bi bi-check-circle"></i> Publish
        </button>
        
        <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                    data-bs-toggle="dropdown">
                <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportSchedule()">
                    <i class="bi bi-download"></i> Export CSV
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="showTemplateModal()">
                    <i class="bi bi-files"></i> Use Template
                </a></li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<!-- Schedule Grid -->
<div class="card">
    <div class="card-body p-0">
        <div class="schedule-grid">
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="min-width: 120px;">Team Member</th>
                            {% for date in dates %}
                                <th class="text-center" style="min-width: 150px;">
                                    <div class="date-header">
                                        <div class="fw-bold">{{ date.strftime('%a') }}</div>
                                        <small>{{ date.strftime('%b %d') }}</small>
                                    </div>
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in team_members %}
                        <tr>
                            <td class="align-middle">
                                <div class="d-flex align-items-center">
                                    <div class="employee-initials me-2">
                                        {{ member.initials }}
                                    </div>
                                    <div>
                                        <div class="fw-medium">{{ member.full_name }}</div>
                                        {% if member.section %}
                                            <small class="text-muted">{{ member.section.name }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            {% for date in dates %}
                                <td class="align-top p-2" style="min-height: 80px;">
                                    {% set shifts = schedule_grid[member.id][date.isoformat()] %}
                                    {% if shifts %}
                                        <!-- Multiple shifts in one cell -->
                                        {% for shift in shifts %}
                                            <div class="shift-card mb-1" 
                                                 style="background-color: {{ shift.color or shift.status_color }};"
                                                 onclick="editShift({{ shift.id }}, {{ member.id }}, '{{ date.isoformat() }}')">
                                                <div class="fw-bold" style="font-size: 0.7rem;">{{ shift.time_display }}</div>
                                                {% if shift.role %}
                                                    <div style="font-size: 0.65rem;">{{ shift.role }}</div>
                                                {% endif %}
                                                <div style="font-size: 0.65rem;">
                                                    {{ shift.status.value.replace('_', ' ').title() }}
                                                </div>
                                                {% if shifts|length > 1 %}
                                                    <div class="shift-sequence" style="font-size: 0.6rem; opacity: 0.8;">
                                                        #{{ shift.sequence }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                        
                                        <!-- Add another shift button -->
                                        {% if can_edit %}
                                            <div class="add-shift-btn" 
                                                 onclick="createShift({{ member.id }}, '{{ date.isoformat() }}')"
                                                 style="cursor: pointer; text-align: center; padding: 4px; border: 1px dashed #ccc; border-radius: 4px; color: #666; font-size: 0.7rem;">
                                                <i class="bi bi-plus"></i> Add
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        {% if can_edit %}
                                            <div class="shift-card bg-light text-dark border border-dashed" 
                                                 onclick="createShift({{ member.id }}, '{{ date.isoformat() }}')"
                                                 style="min-height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                <i class="bi bi-plus"></i>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Multi-Shift Management Modal -->
<div class="modal fade" id="multiShiftModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="multiShiftModalTitle">Manage Daily Shifts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="multiShiftEmployee" class="mb-3"></div>
                <div id="multiShiftDate" class="mb-3"></div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Today's Shifts</h6>
                    <button class="btn btn-sm btn-primary" onclick="addNewShift()">
                        <i class="bi bi-plus"></i> Add Shift
                    </button>
                </div>
                
                <div id="shiftsContainer">
                    <!-- Shifts will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="shiftModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shiftModalTitle">Edit Shift</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="shiftForm">
                    <input type="hidden" id="shiftId" name="shift_id">
                    <input type="hidden" id="employeeId" name="employee_id">
                    
                    <div class="mb-3">
                        <label class="form-label">Employee</label>
                        <div id="employeeInfo" class="form-control-plaintext"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shiftDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="shiftDate" name="date" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startTime" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="startTime" name="start_time">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endTime" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="endTime" name="end_time">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shiftRole" class="form-label">Role</label>
                        <input type="text" class="form-control" id="shiftRole" name="role" 
                               placeholder="e.g., Cashier, Manager">
                    </div>
                    
                    <div class="mb-3">
                        <label for="shiftStatus" class="form-label">Status</label>
                        <select class="form-select" id="shiftStatus" name="status">
                            <option value="scheduled">Scheduled</option>
                            <option value="rest_day">Rest Day</option>
                            <option value="sick_leave">Sick Leave</option>
                            <option value="personal_leave">Personal Leave</option>
                            <option value="emergency_leave">Emergency Leave</option>
                            <option value="annual_vacation">Annual Vacation</option>
                            <option value="holiday_off">Holiday Off</option>
                            <option value="offset">Offset</option>
                            <option value="bereavement_leave">Bereavement Leave</option>
                            <option value="paternity_leave">Paternity Leave</option>
                            <option value="maternity_leave">Maternity Leave</option>
                            <option value="union_leave">Union Leave</option>
                            <option value="fire_calamity_leave">Fire/Calamity Leave</option>
                            <option value="solo_parent_leave">Solo Parent Leave</option>
                            <option value="special_leave_women">Special Leave for Women</option>
                            <option value="vawc_leave">VAWC Leave</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shiftNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="shiftNotes" name="notes" rows="3" 
                                  placeholder="Leave a note for your employee..."></textarea>
                        <small class="text-muted">You've used 0 of 3 free Shift Notes this month.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Shift Color</label>
                        <div class="color-picker-grid">
                            <!-- Primary Colors -->
                            <div class="color-option" data-color="#007bff" style="background-color: #007bff;" title="Primary Blue"></div>
                            <div class="color-option" data-color="#6c757d" style="background-color: #6c757d;" title="Secondary Gray"></div>
                            <div class="color-option" data-color="#28a745" style="background-color: #28a745;" title="Success Green"></div>
                            <div class="color-option" data-color="#dc3545" style="background-color: #dc3545;" title="Danger Red"></div>
                            <div class="color-option" data-color="#ffc107" style="background-color: #ffc107;" title="Warning Yellow"></div>
                            <div class="color-option" data-color="#17a2b8" style="background-color: #17a2b8;" title="Info Cyan"></div>
                            
                            <!-- Secondary Colors -->
                            <div class="color-option" data-color="#6f42c1" style="background-color: #6f42c1;" title="Purple"></div>
                            <div class="color-option" data-color="#e83e8c" style="background-color: #e83e8c;" title="Pink"></div>
                            <div class="color-option" data-color="#fd7e14" style="background-color: #fd7e14;" title="Orange"></div>
                            <div class="color-option" data-color="#20c997" style="background-color: #20c997;" title="Teal"></div>
                            <div class="color-option" data-color="#0dcaf0" style="background-color: #0dcaf0;" title="Light Blue"></div>
                            <div class="color-option" data-color="#495057" style="background-color: #495057;" title="Dark Gray"></div>
                            
                            <!-- Tertiary Colors -->
                            <div class="color-option" data-color="#f8d7da" style="background-color: #f8d7da;" title="Light Pink"></div>
                            <div class="color-option" data-color="#d1ecf1" style="background-color: #d1ecf1;" title="Light Cyan"></div>
                            <div class="color-option" data-color="#d4edda" style="background-color: #d4edda;" title="Light Green"></div>
                            <div class="color-option" data-color="#fff3cd" style="background-color: #fff3cd;" title="Light Yellow"></div>
                            <div class="color-option" data-color="#dee2e6" style="background-color: #dee2e6;" title="Light Gray"></div>
                            <div class="color-option" data-color="#212529" style="background-color: #212529;" title="Dark"></div>
                        </div>
                        <input type="hidden" id="shiftColor" name="color" value="#007bff">
                        <div class="mt-2">
                            <small class="text-muted">Selected color: <span id="colorDisplay" class="fw-bold">#007bff</span></small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteShiftBtn" onclick="deleteShift()">
                    Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveShift()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="exportStartDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="exportStartDate" name="start_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="exportEndDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="exportEndDate" name="end_date" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="doExport()">Export CSV</button>
            </div>
        </div>
    </div>
</div>

<!-- Template Selection Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Apply Schedule Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Standard Weekday Template</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="applyTemplate('standard')">Apply</button>
                        </div>
                        <p class="mb-1">Mon-Fri: 9am-5pm shifts</p>
                        <small>Standard business hours template</small>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Retail Template</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="applyTemplate('retail')">Apply</button>
                        </div>
                        <p class="mb-1">7 days: 10am-9pm shifts with rotating staff</p>
                        <small>Retail store schedule with weekend coverage</small>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Restaurant Template</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="applyTemplate('restaurant')">Apply</button>
                        </div>
                        <p class="mb-1">Split shifts: 11am-3pm & 5pm-10pm</p>
                        <small>Restaurant service with lunch and dinner shifts</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentShiftId = null;
let currentEmployeeId = null;
let currentDate = null;
let allEmployeeShifts = [];

function navigateDate(direction) {
    const currentDate = new Date(document.getElementById('date-picker').value);
    const viewType = '{{ view_type }}';
    
    if (viewType === 'day') {
        currentDate.setDate(currentDate.getDate() + direction);
    } else if (viewType === 'week') {
        currentDate.setDate(currentDate.getDate() + (direction * 7));
    } else if (viewType === 'month') {
        currentDate.setMonth(currentDate.getMonth() + direction);
    }
    
    window.location.href = `{{ url_for('schedule.view_schedule') }}?view={{ view_type }}&date=${currentDate.toISOString().split('T')[0]}`;
}

function navigateToDate(dateStr) {
    window.location.href = `{{ url_for('schedule.view_schedule') }}?view={{ view_type }}&date=${dateStr}`;
}

// NEW: Show multi-shift modal for days with multiple shifts or to add shifts
function showMultiShiftModal(employeeId, date) {
    currentEmployeeId = employeeId;
    currentDate = date;
    
    const employee = getEmployeeInfo(employeeId);
    document.getElementById('multiShiftEmployee').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="employee-initials me-2">${employee.initials}</div>
            <strong>${employee.name}</strong>
        </div>
    `;
    
    document.getElementById('multiShiftDate').innerHTML = `
        <strong>Date:</strong> ${new Date(date).toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        })}
    `;
    
    // Load all shifts for this employee/date
    loadEmployeeShifts(employeeId, date);
    
    new bootstrap.Modal(document.getElementById('multiShiftModal')).show();
}

function loadEmployeeShifts(employeeId, date) {
    fetch(`/schedule/api/shifts/${employeeId}/${date}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allEmployeeShifts = data.shifts;
                renderShiftsContainer();
            } else {
                console.error('Error loading shifts:', data.error);
                allEmployeeShifts = [];
                renderShiftsContainer();
            }
        })
        .catch(error => {
            console.error('Error loading shifts:', error);
            allEmployeeShifts = [];
            renderShiftsContainer();
        });
}

function renderShiftsContainer() {
    const container = document.getElementById('shiftsContainer');
    
    if (allEmployeeShifts.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="bi bi-calendar-x display-6"></i>
                <p class="mt-2">No shifts scheduled for this day</p>
                <button class="btn btn-outline-primary" onclick="addNewShift()">
                    <i class="bi bi-plus"></i> Add First Shift
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    allEmployeeShifts.forEach((shift, index) => {
        html += `
            <div class="card mb-2" style="border-left: 4px solid ${shift.color};">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-secondary me-2">#${shift.sequence}</span>
                                <strong>${shift.start_time && shift.end_time ? 
                                    shift.start_time + ' - ' + shift.end_time : 'No time set'}</strong>
                            </div>
                            
                            ${shift.role ? `<div class="text-muted small">Role: ${shift.role}</div>` : ''}
                            <div class="text-muted small">Status: ${shift.status.replace('_', ' ')}</div>
                            ${shift.notes ? `<div class="text-muted small mt-1">Notes: ${shift.notes}</div>` : ''}
                        </div>
                        
                        <div class="btn-group-vertical btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="editShift(${shift.id}, ${currentEmployeeId}, '${currentDate}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteShiftConfirm(${shift.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function addNewShift() {
    currentShiftId = null;
    
    // Reset form
    document.getElementById('shiftForm').reset();
    document.getElementById('shiftId').value = '';
    document.getElementById('employeeId').value = currentEmployeeId;
    document.getElementById('shiftDate').value = currentDate;
    
    // Reset color picker to default
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.color === '#007bff') {
            option.classList.add('selected');
        }
    });
    document.getElementById('shiftColor').value = '#007bff';
    document.getElementById('colorDisplay').textContent = '#007bff';
    
    // Set employee info
    const employee = getEmployeeInfo(currentEmployeeId);
    document.getElementById('employeeInfo').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="employee-initials me-2">${employee.initials}</div>
            <span>${employee.name}</span>
        </div>
    `;
    
    document.getElementById('shiftModalTitle').textContent = 'Add New Shift';
    document.getElementById('deleteShiftBtn').style.display = 'none';
    
    // Enable all fields
    document.querySelectorAll('#startTime, #endTime, #shiftRole').forEach(field => {
        field.removeAttribute('disabled');
    });
    
    new bootstrap.Modal(document.getElementById('shiftModal')).show();
}

function deleteShiftConfirm(shiftId) {
    if (confirm('Are you sure you want to delete this shift?')) {
        fetch(`/schedule/api/shift/${shiftId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage('Shift deleted successfully!');
                // Reload shifts in the modal
                loadEmployeeShifts(currentEmployeeId, currentDate);
                // Also refresh the page after a delay
                setTimeout(() => location.reload(), 1500);
            } else {
                alert('Error deleting shift: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting shift:', error);
            alert('Error deleting shift');
        });
    }
}

// UPDATED: Check if cell has multiple shifts and show appropriate modal
function createShift(employeeId, date) {
    // First check if there are existing shifts for this day
    fetch(`/schedule/api/shifts/${employeeId}/${date}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.shifts.length > 0) {
                // Show multi-shift modal if shifts already exist
                showMultiShiftModal(employeeId, date);
            } else {
                // Show regular create modal for first shift
                showCreateShiftModal(employeeId, date);
            }
        })
        .catch(error => {
            console.error('Error checking shifts:', error);
            showCreateShiftModal(employeeId, date);
        });
}

function showCreateShiftModal(employeeId, date) {
    currentShiftId = null;
    currentEmployeeId = employeeId;
    
    // Reset form
    document.getElementById('shiftForm').reset();
    document.getElementById('shiftId').value = '';
    document.getElementById('employeeId').value = employeeId;
    document.getElementById('shiftDate').value = date;
    
    // Reset color picker to default
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.color === '#007bff') {
            option.classList.add('selected');
        }
    });
    document.getElementById('shiftColor').value = '#007bff';
    document.getElementById('colorDisplay').textContent = '#007bff';
    
    // Set employee info
    const employee = getEmployeeInfo(employeeId);
    document.getElementById('employeeInfo').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="employee-initials me-2">${employee.initials}</div>
            <span>${employee.name}</span>
        </div>
    `;
    
    document.getElementById('shiftModalTitle').textContent = 'Create Shift';
    document.getElementById('deleteShiftBtn').style.display = 'none';
    
    // Enable all fields for new shift
    document.querySelectorAll('#startTime, #endTime, #shiftRole').forEach(field => {
        field.removeAttribute('disabled');
    });
    
    new bootstrap.Modal(document.getElementById('shiftModal')).show();
}

function editShift(shiftId, employeeId, date) {
    currentShiftId = shiftId;
    currentEmployeeId = employeeId;
    
    // Load shift data from server
    fetch(`/schedule/api/shift/${shiftId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const shift = data.shift;
                document.getElementById('shiftId').value = shift.id;
                document.getElementById('employeeId').value = shift.employee_id;
                document.getElementById('shiftDate').value = shift.date;
                document.getElementById('startTime').value = shift.start_time || '';
                document.getElementById('endTime').value = shift.end_time || '';
                document.getElementById('shiftRole').value = shift.role || '';
                document.getElementById('shiftStatus').value = shift.status;
                document.getElementById('shiftNotes').value = shift.notes || '';
                
                // Set color picker
                const shiftColor = shift.color || '#007bff';
                document.getElementById('shiftColor').value = shiftColor;
                document.getElementById('colorDisplay').textContent = shiftColor;
                
                // Update color picker selection
                document.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.color === shiftColor) {
                        option.classList.add('selected');
                    }
                });
                
                const employee = getEmployeeInfo(employeeId);
                document.getElementById('employeeInfo').innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="employee-initials me-2">${employee.initials}</div>
                        <span>${employee.name}</span>
                    </div>
                `;
                
                document.getElementById('shiftModalTitle').textContent = 'Edit Shift';
                document.getElementById('deleteShiftBtn').style.display = 'block';
                
                new bootstrap.Modal(document.getElementById('shiftModal')).show();
            } else {
                alert('Error loading shift: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading shift:', error);
            alert('Error loading shift data');
        });
}

function saveShift() {
    const formData = new FormData(document.getElementById('shiftForm'));
    const data = Object.fromEntries(formData.entries());
    
    fetch('/schedule/api/shift', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showSuccessMessage(data.message || 'Shift saved successfully!');
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('shiftModal')).hide();
            
            // Reload the page to show updated schedule
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert('Error saving shift: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving shift:', error);
        alert('Error saving shift');
    });
}

function deleteShift() {
    if (!currentShiftId) return;
    
    if (confirm('Are you sure you want to delete this shift?')) {
        fetch(`/schedule/api/shift/${currentShiftId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage(data.message || 'Shift deleted successfully!');
                bootstrap.Modal.getInstance(document.getElementById('shiftModal')).hide();
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('Error deleting shift: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting shift:', error);
            alert('Error deleting shift');
        });
    }
}

// Helper function to show success messages
function showSuccessMessage(message) {
    // Create success alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

function getEmployeeInfo(employeeId) {
    // This would normally come from the server, but for demo purposes:
    const employees = {
        {% for member in team_members %}
        {{ member.id }}: {
            name: '{{ member.full_name }}',
            initials: '{{ member.initials }}'
        },
        {% endfor %}
    };
    return employees[employeeId] || { name: 'Unknown', initials: '??' };
}

function publishSchedule() {
    if (confirm('Are you sure you want to publish this schedule? Team members will be notified.')) {
        alert('Schedule published successfully! Notifications sent to team members.');
    }
}

function exportSchedule() {
    // Set default date range to current week
    const today = new Date('{{ selected_date.isoformat() }}');
    const monday = new Date(today);
    monday.setDate(today.getDate() - today.getDay() + 1);
    const sunday = new Date(today);
    sunday.setDate(today.getDate() - today.getDay() + 7);
    
    document.getElementById('exportStartDate').value = monday.toISOString().split('T')[0];
    document.getElementById('exportEndDate').value = sunday.toISOString().split('T')[0];
    
    new bootstrap.Modal(document.getElementById('exportModal')).show();
}

function doExport() {
    const startDate = document.getElementById('exportStartDate').value;
    const endDate = document.getElementById('exportEndDate').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }
    
    window.location.href = `{{ url_for('schedule.export_schedule') }}?start_date=${startDate}&end_date=${endDate}`;
    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
}

function showTemplateModal() {
    new bootstrap.Modal(document.getElementById('templateModal')).show();
}

function applyTemplate(templateType) {
    if (confirm(`Apply ${templateType} template to current schedule? This will overwrite existing shifts.`)) {
        alert(`${templateType.charAt(0).toUpperCase() + templateType.slice(1)} template applied successfully!`);
        bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
        location.reload();
    }
}

// Color picker functionality and other event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Color picker logic
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            // Remove selected class from all options
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            this.classList.add('selected');
            
            // Update hidden input and display
            const selectedColor = this.dataset.color;
            document.getElementById('shiftColor').value = selectedColor;
            document.getElementById('colorDisplay').textContent = selectedColor;
        });
    });
    
    // Status change logic
    const statusSelect = document.getElementById('shiftStatus');
    if (statusSelect) {
        statusSelect.addEventListener('change', function() {
            const timeFields = document.querySelectorAll('#startTime, #endTime');
            const roleField = document.getElementById('shiftRole');
            
            if (this.value === 'scheduled') {
                timeFields.forEach(field => field.removeAttribute('disabled'));
                roleField.removeAttribute('disabled');
            } else {
                timeFields.forEach(field => {
                    field.setAttribute('disabled', 'disabled');
                    field.value = '';
                });
                roleField.setAttribute('disabled', 'disabled');
                roleField.value = '';
            }
        });
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                navigateDate(-1);
                break;
            case 'ArrowRight':
                e.preventDefault();
                navigateDate(1);
                break;
            case 'e':
                if ({{ can_edit|lower }}) {
                    e.preventDefault();
                    exportSchedule();
                }
                break;
            case 'p':
                if ({{ can_edit|lower }}) {
                    e.preventDefault();
                    publishSchedule();
                }
                break;
        }
    }
});
</script>
{% endblock %}