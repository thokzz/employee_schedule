{% extends "base.html" %}

{% block title %}Schedule{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/schedule.css') }}" rel="stylesheet">
<style>
/* Template-specific styles */
.template-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
    position: relative;
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: #007bff;
}

.template-card .card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
}

.template-card .dropdown-toggle {
    border: none;
    box-shadow: none;
}

.template-card .dropdown-toggle:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.template-alert {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.badge.bg-success {
    background-color: #198754 !important;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
}

.alert-container {
    position: relative;
    z-index: 1000;
}

.template-quick-actions {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1050;
}

.template-quick-actions .btn {
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

@media (max-width: 768px) {
    .template-quick-actions {
        position: relative;
        bottom: auto;
        right: auto;
        margin-top: 15px;
        text-align: center;
    }
    
    .template-quick-actions .btn {
        margin: 0 5px 10px 0;
    }
    
    .template-card .card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .template-card .dropdown {
        align-self: flex-end;
        margin-top: 8px;
    }
    
    .modal-dialog {
        margin: 10px;
    }
    
    .btn-group .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.5rem;
    }
}

/* Enhanced dropdown for template actions */
.dropdown-menu {
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 8px;
}

.dropdown-menu .dropdown-header {
    font-weight: 600;
    color: #495057;
    background-color: #f8f9fa;
    border-radius: 6px 6px 0 0;
}

.dropdown-menu .dropdown-item {
    padding: 8px 16px;
    transition: all 0.2s ease;
}

.dropdown-menu .dropdown-item:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
}

.dropdown-menu .dropdown-item.text-danger:hover {
    background-color: #f8d7da;
    color: #721c24 !important;
}

.template-preview-grid {
    max-height: 300px;
    overflow-y: auto;
}

.template-employee-mapping {
    background-color: #f8f9fa;
    border-radius: 6px;
    padding: 10px;
    margin: 5px 0;
}

.quick-template-selector {
    position: sticky;
    top: 0;
    background: white;
    z-index: 100;
    padding: 10px 0;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 15px;
}

/* Enhanced modal styling */
.modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-header {
    border-bottom: 1px solid #e9ecef;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px 12px 0 0;
}

.nav-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    background-color: #007bff;
    color: white;
    border-radius: 6px;
}

/* Preview section styling */
#applicationPreview .card {
    border: 1px solid #e3f2fd;
    background-color: #f8f9fa;
}

#applicationPreview .card-header {
    background-color: #e3f2fd;
    border-bottom: 1px solid #bbdefb;
}
</style>
{% endblock %}

{% block content %}
<!-- Schedule Header with Template Actions -->
{% include 'schedule/partials/header.html' %}

<!-- Schedule Grid -->
{% include 'schedule/partials/grid.html' %}

<!-- Context Menus -->
{% include 'schedule/partials/context_menus.html' %}

<!-- All Modals (including new template modals) -->
{% include 'schedule/partials/modals.html' %}

<!-- Enhanced Template Management Modal with Delete Functionality -->
<div class="modal fade" id="templateManagementModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-files"></i> Schedule Templates
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Template Actions Tabs -->
                <ul class="nav nav-tabs mb-3" id="templateTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="browse-tab" data-bs-toggle="tab" data-bs-target="#browse-templates">
                            <i class="bi bi-search"></i> Browse Templates
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-template">
                            <i class="bi bi-camera"></i> Create Snapshot
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Browse Templates Tab -->
                    <div class="tab-pane fade show active" id="browse-templates">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="input-group" style="max-width: 300px;">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="templateSearch" placeholder="Search templates...">
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary btn-sm active" onclick="filterTemplates('all')">All</button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="filterTemplates('mine')">My Templates</button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="filterTemplates('public')">Public</button>
                            </div>
                        </div>

                        <div id="templatesGrid" class="row">
                            <!-- Templates will be loaded here -->
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading templates...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create Template Tab -->
                    <div class="tab-pane fade" id="create-template">
                        <form id="createTemplateForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Template Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="name" required placeholder="e.g., Standard Weekly Schedule">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" name="description" rows="3" placeholder="Describe when and how this template should be used..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" name="is_public" id="templatePublic">
                                            <label class="form-check-label" for="templatePublic">
                                                <i class="bi bi-globe"></i> Make template public (others can use it)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Source Date Range <span class="text-danger">*</span></label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="date" class="form-control" name="start_date" required>
                                                <small class="text-muted">Start Date</small>
                                            </div>
                                            <div class="col-6">
                                                <input type="date" class="form-control" name="end_date" required>
                                                <small class="text-muted">End Date</small>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">Maximum 14 days allowed</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Organizational Scope</label>
                                        <select class="form-select" name="scope_type" onchange="updateScopeOptions()">
                                            <option value="">Use Current User's Scope</option>
                                            <option value="department">Department</option>
                                            <option value="division">Division</option>
                                            <option value="section">Section</option>
                                            <option value="unit">Unit</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="scopeSelection" style="display: none;">
                                        <select class="form-select" name="scope_id">
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Snapshot Creation:</strong> This will capture all shifts in the selected date range and organizational scope, creating a reusable template pattern.
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="templateActions">
                    <!-- Action buttons will appear here based on active tab -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Apply Template Modal -->
<div class="modal fade" id="applyTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat"></i> Apply Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Template Info -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0" id="selectedTemplateName">Template Name</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Duration:</small><br>
                                <span id="templateDuration">7 days</span>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Employees:</small><br>
                                <span id="templateEmployees">15 employees</span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <small class="text-muted">Shifts:</small><br>
                                <span id="templateShifts">105 shifts</span>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Scope:</small><br>
                                <span id="templateScope">Section: IT Department</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Application Form -->
                <form id="applyTemplateForm">
                    <input type="hidden" name="template_id" id="applyTemplateId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Target Date Range <span class="text-danger">*</span></label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="date" class="form-control" name="target_start_date" required>
                                        <small class="text-muted">Start Date</small>
                                    </div>
                                    <div class="col-6">
                                        <input type="date" class="form-control" name="target_end_date" required>
                                        <small class="text-muted">End Date</small>
                                    </div>
                                </div>
                                <small class="form-text text-muted">Must match template duration</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Target Organizational Unit</label>
                                <select class="form-select" name="target_scope_type" onchange="updateTargetScopeOptions()">
                                    <option value="">Use Template's Original Scope</option>
                                    <option value="section">Section</option>
                                    <option value="unit">Unit</option>
                                </select>
                            </div>
                            <div class="mb-3" id="targetScopeSelection" style="display: none;">
                                <select class="form-select" name="target_scope_id">
                                    <!-- Options populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="replace_existing" id="replaceExisting">
                            <label class="form-check-label" for="replaceExisting">
                                <i class="bi bi-arrow-clockwise"></i> Replace existing shifts in target date range
                            </label>
                        </div>
                        <small class="form-text text-muted">If unchecked, will skip dates that already have shifts</small>
                    </div>

                    <!-- Preview Section -->
                    <div id="applicationPreview" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-eye"></i> Application Preview</h6>
                            </div>
                            <div class="card-body">
                                <div id="previewContent">
                                    <!-- Preview content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" onclick="generatePreview()">
                    <i class="bi bi-eye"></i> Preview
                </button>
                <button type="button" class="btn btn-primary" onclick="applySelectedTemplate()">
                    <i class="bi bi-check"></i> Apply Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Apply Template Modal -->
<div class="modal fade" id="quickApplyTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-lightning"></i> Quick Apply Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Template <span class="text-danger">*</span></label>
                    <select class="form-select" id="quickTemplateSelect" required>
                        <option value="">Choose a template...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Target Start Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="quickTargetDate" required>
                    <small class="form-text text-muted">Template will be applied starting from this date</small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="quickReplaceExisting">
                    <label class="form-check-label" for="quickReplaceExisting">
                        <i class="bi bi-arrow-clockwise"></i> Replace existing shifts
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="quickApplyTemplate()">
                    <i class="bi bi-check"></i> Apply
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template Details Modal -->
<div class="modal fade" id="templateDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-text"></i> Template Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="templateDetailsContent">
                    <!-- Template details will be loaded here -->
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading template details...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" onclick="duplicateCurrentTemplate()">
                    <i class="bi bi-files"></i> Duplicate
                </button>
                <button type="button" class="btn btn-primary" onclick="useCurrentTemplate()">
                    <i class="bi bi-arrow-repeat"></i> Use Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Template Actions for Mobile -->
{% if can_edit %}
<div class="template-quick-actions d-md-none">
    <button class="btn btn-info btn-sm rounded-pill" onclick="showTemplateModal()" title="Template Management">
        <i class="bi bi-files"></i>
    </button>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<!-- Pass template variables to JavaScript -->
<script>
window.scheduleConfig = {
    viewType: '{{ view_type }}',
    canEdit: {{ can_edit|lower }},
    selectedDate: '{{ selected_date.isoformat() }}',
    teamMembers: {
        {% for member in team_members %}
        {{ member.id }}: {
            name: '{{ member.full_name }}',
            initials: '{{ member.initials }}'
        }{{ ',' if not loop.last }}
        {% endfor %}
    },
    dates: {
        first: '{{ dates[0].isoformat() }}',
        last: '{{ dates[-1].isoformat() }}'
    },
    urls: {
        viewSchedule: '{{ url_for("schedule.view_schedule") }}',
        exportSchedule: '{{ url_for("schedule.export_schedule") }}',
        exportWorksched: '{{ url_for("schedule.export_worksched") }}'
    }
};

// ADD THIS LINE - Important for permission checking
window.currentUserId = {{ current_user.id }};
window.currentUser = {
    id: {{ current_user.id }},
    name: '{{ current_user.full_name }}',
    role: '{{ current_user.role.value }}'
};
</script>

<!-- Load JavaScript modules -->
<script src="{{ url_for('static', filename='js/schedule/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/schedule/shifts.js') }}"></script>
<script src="{{ url_for('static', filename='js/schedule/date_remarks.js') }}"></script>
<script src="{{ url_for('static', filename='js/schedule/holidays.js') }}"></script>
<script src="{{ url_for('static', filename='js/schedule/export.js') }}"></script>
<!-- FIXED: Only load templates.js once -->
<script src="{{ url_for('static', filename='js/schedule/templates.js') }}"></script>

<script>
// Enhanced refresh function for template integration
function refreshScheduleView() {
    const currentUrl = new URL(window.location);
    window.location.reload();
}

// Auto-populate quick template modal with current date
document.addEventListener('DOMContentLoaded', function() {
    const quickDateInput = document.getElementById('quickTargetDate');
    if (quickDateInput && window.scheduleConfig.viewType === 'week') {
        quickDateInput.value = window.scheduleConfig.dates.first;
    }
});
</script>
{% endblock %}