<!-- Create new file: app/templates/work_extension/request_form.html -->

{% extends "base.html" %}

{% block title %}Request Work Extension{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Request Work Extension</h1>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle"></i> 
    <strong>Work Extension Request:</strong> This form is for Confidential employees to request approval for overtime work. 
    Use this when you need to work beyond your scheduled hours.
</div>

<form action="{{ url_for('work_extension.submit_work_extension') }}" method="POST" class="work-extension-form">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4><i class="bi bi-person-circle"></i> Employee Information</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label class="form-label">Employee Name</label>
                        <input type="text" class="form-control" value="{{ current_user.full_name }}" readonly>
                        <input type="hidden" name="employee_id" value="{{ current_user.id }}">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label class="form-label">Section</label>
                        <input type="text" class="form-control" 
                               value="{{ current_user.section.name if current_user.section else 'Not Assigned' }}" readonly>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label for="contact" class="form-label">Contact Number <span class="text-danger">*</span></label>
                        <input type="tel" id="contact" name="contact" class="form-control" required 
                               value="{{ current_user.contact_number or '' }}"
                               placeholder="Contact number during extended work">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h4><i class="bi bi-clock"></i> Work Extension Details</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="extension_date" class="form-label">Date of Extended Work <span class="text-danger">*</span></label>
                        <input type="date" id="extension_date" name="extension_date" class="form-control" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Regular Shift Schedule</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="shift_start" class="form-label">Shift Start Time</label>
                                <input type="time" id="shift_start" name="shift_start" class="form-control">
                                <small class="text-muted">Your regular scheduled start time</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="shift_end" class="form-label">Shift End Time</label>
                                <input type="time" id="shift_end" name="shift_end" class="form-control">
                                <small class="text-muted">Your regular scheduled end time</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h5>Actual Time</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="actual_time_in" class="form-label">Actual Time In</label>
                                <input type="time" id="actual_time_in" name="actual_time_in" class="form-control">
                                <small class="text-muted">When you actually started work</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="actual_time_out" class="form-label">Actual Time Out</label>
                                <input type="time" id="actual_time_out" name="actual_time_out" class="form-control">
                                <small class="text-muted">When you actually finished work</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Extended Time Period <span class="text-danger">*</span></h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="extended_from" class="form-label">Extended From <span class="text-danger">*</span></label>
                                <input type="time" id="extended_from" name="extended_from" class="form-control" required>
                                <small class="text-muted">Start of overtime period</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="extended_to" class="form-label">Extended To <span class="text-danger">*</span></label>
                                <input type="time" id="extended_to" name="extended_to" class="form-control" required>
                                <small class="text-muted">End of overtime period</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h5>Extension Summary</h5>
                    <div class="form-group mb-3">
                        <label for="extension_hours" class="form-label">Total Extension Hours</label>
                        <input type="text" id="extension_hours" name="extension_hours" class="form-control" readonly>
                        <small class="text-muted">Automatically calculated</small>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group mb-3">
                        <label for="reason" class="form-label">Reason for Extended Work <span class="text-danger">*</span></label>
                        <textarea id="reason" name="reason" rows="4" class="form-control" required 
                                  placeholder="Please provide detailed reason for the need to extend work hours..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approver Information Section -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-white">
            <h4><i class="bi bi-person-check"></i> Approver Information</h4>
        </div>
        <div class="card-body">
            {% if approver %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Your designated approver has been automatically selected. You can change it if needed.
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">Designated Approver</label>
                            <input type="text" class="form-control" value="{{ approver.full_name }}" readonly>
                            {% if approver.job_title %}
                                <small class="text-muted">{{ approver.job_title }} - {{ approver.approver_scope or 'All Employees' }}</small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">Email</label>
                            <input type="text" class="form-control" value="{{ approver.email }}" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- ALWAYS show the approver selection if there are available approvers -->
                {% if available_approvers|length > 0 %}
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="change_work_extension_approver">
                    <label class="form-check-label" for="change_work_extension_approver">
                        <strong>Select a different approver from your unit/section ({{ available_approvers|length }} available)</strong>
                    </label>
                </div>
                
                <div id="work_extension_approver_selection" style="display: none;">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group mb-3">
                                <label for="approver_id_select" class="form-label">Available Approvers in Your Unit/Section <span class="text-danger">*</span></label>
                                <select id="approver_id_select" name="approver_id" class="form-select">
                                    <!-- Always include the designated approver as the first option -->
                                    <option value="{{ approver.id }}" selected
                                        data-email="{{ approver.email }}"
                                        data-signature="{{ approver.signature_path or '' }}">
                                        {{ approver.full_name }}
                                        {% if approver.job_title %} - {{ approver.job_title }}{% endif %}
                                        ({{ approver.approver_scope or 'All Employees' }}) [Designated]
                                    </option>
                                    <!-- Add all other available approvers -->
                                    {% for manager in available_approvers %}
                                        {% if manager.is_active and manager.id != approver.id %}
                                        <option value="{{ manager.id }}"
                                            data-email="{{ manager.email }}"
                                            data-signature="{{ manager.signature_path or '' }}">
                                            {{ manager.full_name }}
                                            {% if manager.job_title %} - {{ manager.job_title }}{% endif %}
                                            ({{ manager.approver_scope or 'All Employees' }})
                                            {% if manager.section_id == current_user.section_id %}[Same Section]{% endif %}
                                            {% if manager.unit_id == current_user.unit_id %}[Same Unit]{% endif %}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                
                                <!-- Hidden fields for approver selection -->
                                <input type="hidden" id="work_ext_approver_email" name="approver_email" value="{{ approver.email }}">
                                <input type="hidden" id="work_ext_approver_name" name="approver_name" value="{{ approver.full_name }}">
                                <input type="hidden" id="work_ext_approver_id" name="approver_id_hidden" value="{{ approver.id }}">
                                <input type="hidden" id="work_ext_appr_sign" name="appr_sign" value="{{ approver.signature_path or '' }}">
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>Only One Approver Available:</strong> No other approvers found in your unit/section.
                </div>
                <!-- Still need hidden fields for the designated approver -->
                <input type="hidden" id="approver_id" name="approver_id" value="{{ approver.id }}">
                <input type="hidden" id="work_ext_approver_email" name="approver_email" value="{{ approver.email }}">
                <input type="hidden" id="work_ext_approver_name" name="approver_name" value="{{ approver.full_name }}">
                <input type="hidden" id="work_ext_approver_id" name="approver_id_hidden" value="{{ approver.id }}">
                <input type="hidden" id="work_ext_appr_sign" name="appr_sign" value="{{ approver.signature_path or '' }}">
                {% endif %}
                
            {% else %}
                {% if available_approvers %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>No Designated Approver:</strong> You don't have a specific designated approver. Please select from {{ available_approvers|length }} available approvers in your unit/section below.
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group mb-3">
                            <label for="approver_id" class="form-label">Select Approver from Your Unit/Section <span class="text-danger">*</span></label>
                            <select id="approver_id" name="approver_id" required class="form-select">
                                <option value="" disabled selected>Select approver</option>
                                {% for manager in available_approvers %}
                                    {% if manager.is_active %}
                                    <option value="{{ manager.id }}"
                                        data-email="{{ manager.email }}"
                                        data-signature="{{ manager.signature_path or '' }}">
                                        {{ manager.full_name }}
                                        {% if manager.job_title %} - {{ manager.job_title }}{% endif %}
                                        ({{ manager.approver_scope or 'All Employees' }})
                                        {% if manager.section_id == current_user.section_id %}[Same Section]{% endif %}
                                        {% if manager.unit_id == current_user.unit_id %}[Same Unit]{% endif %}
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            
                            <!-- Hidden fields for manual approver selection -->
                            <input type="hidden" id="work_ext_approver_email" name="approver_email">
                            <input type="hidden" id="work_ext_approver_name" name="approver_name">
                            <input type="hidden" id="work_ext_approver_id" name="approver_id_hidden">
                            <input type="hidden" id="work_ext_appr_sign" name="appr_sign">
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>No Available Approvers:</strong> There are no available approvers in your unit/section. 
                    Please contact your administrator to assign approvers before submitting work extension requests.
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    <div class="form-actions text-center mb-4">
        <button type="submit" class="btn btn-primary btn-lg me-3" {{ 'disabled' if not approver and not available_approvers }}>
            <i class="bi bi-send"></i> Submit Work Extension Request
        </button>
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary btn-lg">
            <i class="bi bi-x-circle"></i> Cancel
        </a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== WORK EXTENSION FORM INITIALIZED ===');
    
    // ========================================
    // APPROVER SELECTION LOGIC - SAME AS LEAVE REQUESTS
    // ========================================
    
    const workExtApproverCheckbox = document.getElementById('change_work_extension_approver');
    const workExtApproverDropdownSection = document.getElementById('work_extension_approver_selection');
    const workExtManagerSelectElement = document.getElementById('approver_id_select') || document.getElementById('approver_id');
    
    console.log('üîç Work Extension Approver Elements Check:');
    console.log('  - Checkbox found:', !!workExtApproverCheckbox);
    console.log('  - Dropdown section found:', !!workExtApproverDropdownSection);
    console.log('  - Manager select found:', !!workExtManagerSelectElement);
    
    // Setup work extension approver toggle functionality
    if (workExtApproverCheckbox && workExtApproverDropdownSection) {
        console.log('‚úÖ Setting up work extension approver toggle');
        
        workExtApproverCheckbox.addEventListener('change', function() {
            console.log('üîÑ Work extension approver toggle changed to:', this.checked);
            
            if (this.checked) {
                workExtApproverDropdownSection.style.display = 'block';
                console.log('üëÜ Showing work extension approver dropdown');
            } else {
                workExtApproverDropdownSection.style.display = 'none';
                console.log('üëá Hiding work extension approver dropdown');
                
                // Reset to designated approver (first option)
                if (workExtManagerSelectElement && workExtManagerSelectElement.options.length > 0) {
                    workExtManagerSelectElement.selectedIndex = 0;
                    workExtManagerSelectElement.dispatchEvent(new Event('change'));
                    console.log('üîÑ Reset to designated approver');
                }
            }
        });
        
        // Test toggle functionality
        console.log('üß™ Testing work extension toggle...');
        setTimeout(() => {
            workExtApproverCheckbox.checked = true;
            workExtApproverCheckbox.dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                workExtApproverCheckbox.checked = false;
                workExtApproverCheckbox.dispatchEvent(new Event('change'));
                console.log('‚úÖ Work extension toggle test completed');
            }, 1000);
        }, 500);
        
    } else {
        console.log('‚ùå Work extension approver toggle elements missing');
        if (!workExtApproverCheckbox) console.log('  - Missing: change_work_extension_approver checkbox');
        if (!workExtApproverDropdownSection) console.log('  - Missing: work_extension_approver_selection div');
    }
    
    // Setup work extension manager selection functionality
    if (workExtManagerSelectElement) {
        console.log('‚úÖ Setting up work extension manager selection');
        
        workExtManagerSelectElement.addEventListener('change', function() {
            console.log('üìã Work extension manager selection changed');
            const selectedOption = this.options[this.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const approverEmail = selectedOption.dataset.email || '';
                const approverName = selectedOption.textContent.split(' - ')[0].split(' (')[0].trim();
                const approverId = selectedOption.value;
                const approverSignature = selectedOption.dataset.signature || '';
                
                console.log('üìù Updating work extension hidden fields:', {
                    name: approverName,
                    email: approverEmail,
                    id: approverId
                });
                
                // Update hidden fields - using work extension specific IDs
                const emailField = document.getElementById('work_ext_approver_email');
                const nameField = document.getElementById('work_ext_approver_name');
                const idField = document.getElementById('work_ext_approver_id');
                const signField = document.getElementById('work_ext_appr_sign');
                
                if (emailField) emailField.value = approverEmail;
                if (nameField) nameField.value = approverName;
                if (idField) idField.value = approverId;
                if (signField) signField.value = approverSignature;
                
                // Also update the main approver_id field for form submission
                const mainApproverField = document.querySelector('input[name="approver_id"]');
                if (mainApproverField) mainApproverField.value = approverId;
                
                console.log('‚úÖ Work extension hidden fields updated');
            }
        });
        
        // Trigger initial setup
        if (workExtManagerSelectElement.value) {
            workExtManagerSelectElement.dispatchEvent(new Event('change'));
        }
    }
    
    // ========================================
    // WORK EXTENSION SPECIFIC FUNCTIONALITY
    // ========================================
    
    // Calculate extension hours automatically
    function calculateExtensionHours() {
        const extendedFrom = document.getElementById('extended_from').value;
        const extendedTo = document.getElementById('extended_to').value;
        
        if (extendedFrom && extendedTo) {
            const start = new Date(`2023-01-01T${extendedFrom}:00`);
            let end = new Date(`2023-01-01T${extendedTo}:00`);
            
            // Handle next day extension
            if (end <= start) {
                end = new Date(`2023-01-02T${extendedTo}:00`);
            }
            
            const diff = (end - start) / (1000 * 60 * 60);
            document.getElementById('extension_hours').value = diff.toFixed(2) + ' hours';
        } else {
            document.getElementById('extension_hours').value = '';
        }
    }
    
    // Add event listeners for time calculations
    const extendedFromInput = document.getElementById('extended_from');
    const extendedToInput = document.getElementById('extended_to');
    
    if (extendedFromInput) extendedFromInput.addEventListener('change', calculateExtensionHours);
    if (extendedToInput) extendedToInput.addEventListener('change', calculateExtensionHours);
    
    // Auto-populate shift times based on common schedules
    const shiftStartInput = document.getElementById('shift_start');
    const shiftEndInput = document.getElementById('shift_end');
    const actualTimeInInput = document.getElementById('actual_time_in');
    
    if (shiftStartInput && actualTimeInInput) {
        shiftStartInput.addEventListener('change', function() {
            const startTime = this.value;
            if (startTime && !actualTimeInInput.value) {
                actualTimeInInput.value = startTime;
            }
        });
    }
    
    if (shiftEndInput && extendedFromInput) {
        shiftEndInput.addEventListener('change', function() {
            const endTime = this.value;
            if (endTime && !extendedFromInput.value) {
                extendedFromInput.value = endTime;
            }
        });
    }
    
    // Form validation
    const formElement = document.querySelector('form');
    if (formElement) {
        formElement.addEventListener('submit', function(e) {
            let isValid = true;
            let errorMessage = '';
            
            const extensionDateInput = document.getElementById('extension_date');
            if (!extensionDateInput || !extensionDateInput.value) {
                isValid = false;
                errorMessage = 'Please select the date of extended work';
            }
            
            if (!extendedFromInput || !extendedFromInput.value || !extendedToInput || !extendedToInput.value) {
                isValid = false;
                errorMessage = 'Please specify the extended time period';
            }
            
            const reasonInput = document.getElementById('reason');
            if (!reasonInput || !reasonInput.value.trim()) {
                isValid = false;
                errorMessage = 'Please provide a reason for the work extension';
            }
            
            const contactInput = document.getElementById('contact');
            if (!contactInput || !contactInput.value.trim()) {
                isValid = false;
                errorMessage = 'Please provide a contact number';
            }
            
            // Check if approver is selected (for manual selection case)
            if (workExtManagerSelectElement && workExtManagerSelectElement.tagName === 'SELECT' && !workExtManagerSelectElement.value) {
                isValid = false;
                errorMessage = 'Please select an approver';
            }
            
            if (!isValid) {
                alert(errorMessage);
                e.preventDefault();
            }
        });
    }
    
    // Show helpful tooltips
    const tooltips = {
        'extension_date': 'Select the specific date when you worked extended hours',
        'extended_from': 'The time when your overtime period started',
        'extended_to': 'The time when your overtime period ended',
        'reason': 'Explain why the extended work was necessary (project deadline, urgent task, etc.)'
    };
    
    Object.keys(tooltips).forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.setAttribute('title', tooltips[fieldId]);
        }
    });
    
    console.log('‚úÖ Work extension form initialization completed');
});
</script>
{% endblock %}
